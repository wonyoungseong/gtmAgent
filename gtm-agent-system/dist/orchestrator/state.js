"use strict";
/**
 * Workflow State Management
 * 워크플로우 상태 관리 및 리듀서
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.WorkflowStateManager = void 0;
exports.createInitialState = createInitialState;
exports.workflowReducer = workflowReducer;
exports.getStateManager = getStateManager;
exports.removeStateManager = removeStateManager;
exports.clearAllStateManagers = clearAllStateManagers;
// ==================== Initial State ====================
function createInitialState(sessionId) {
    return {
        sessionId,
        phase: 'idle',
        sourceWorkspace: { accountId: '', containerId: '', workspaceId: '' },
        targetWorkspace: { accountId: '', containerId: '', workspaceId: '' },
        createdEntities: [],
        errors: [],
        warnings: []
    };
}
// ==================== State Reducer ====================
function workflowReducer(state, action) {
    switch (action.type) {
        case 'START':
            return {
                ...state,
                phase: 'analyzing',
                sourceWorkspace: action.payload.source,
                targetWorkspace: action.payload.target,
                startedAt: new Date().toISOString(),
                errors: [],
                warnings: []
            };
        case 'SET_ANALYSIS_RESULT':
            return {
                ...state,
                analysisResult: action.payload
            };
        case 'SET_SOURCE_ENTITIES':
            return {
                ...state,
                sourceEntities: action.payload
            };
        case 'SET_TARGET_ENTITIES':
            return {
                ...state,
                targetEntities: action.payload
            };
        case 'SET_NAMING_PATTERN':
            return {
                ...state,
                namingPattern: action.payload
            };
        case 'SET_ENTITY_NAME_MAP':
            return {
                ...state,
                entityNameMap: action.payload
            };
        case 'SET_CREATION_PLAN':
            return {
                ...state,
                creationPlan: action.payload
            };
        case 'ADD_CREATED_ENTITY':
            return {
                ...state,
                createdEntities: [...state.createdEntities, action.payload]
            };
        case 'SET_ID_MAPPING':
            return {
                ...state,
                idMapping: action.payload
            };
        case 'SET_VALIDATION_REPORT':
            return {
                ...state,
                validationReport: action.payload
            };
        case 'ADD_ERROR':
            return {
                ...state,
                errors: [...state.errors, action.payload]
            };
        case 'ADD_WARNING':
            return {
                ...state,
                warnings: [...state.warnings, action.payload]
            };
        case 'TRANSITION_PHASE':
            return {
                ...state,
                phase: action.payload
            };
        case 'COMPLETE':
            return {
                ...state,
                phase: 'completed',
                completedAt: new Date().toISOString()
            };
        case 'RESET':
            return createInitialState(state.sessionId);
        default:
            return state;
    }
}
// ==================== State Manager Class ====================
class WorkflowStateManager {
    constructor(sessionId) {
        this.listeners = [];
        this.state = createInitialState(sessionId);
    }
    /**
     * 현재 상태 반환
     */
    getState() {
        return { ...this.state };
    }
    /**
     * 액션 디스패치
     */
    dispatch(action) {
        this.state = workflowReducer(this.state, action);
        this.notifyListeners();
    }
    /**
     * 상태 변경 구독
     */
    subscribe(listener) {
        this.listeners.push(listener);
        return () => {
            const index = this.listeners.indexOf(listener);
            if (index !== -1) {
                this.listeners.splice(index, 1);
            }
        };
    }
    /**
     * 리스너 알림
     */
    notifyListeners() {
        for (const listener of this.listeners) {
            listener(this.getState());
        }
    }
    /**
     * 워크플로우 시작
     */
    start(source, target) {
        this.dispatch({ type: 'START', payload: { source, target } });
    }
    /**
     * 페이즈 전환
     */
    transitionTo(phase) {
        this.dispatch({ type: 'TRANSITION_PHASE', payload: phase });
    }
    /**
     * 에러 추가
     */
    addError(error) {
        this.dispatch({ type: 'ADD_ERROR', payload: error });
        if (!error.recoverable) {
            this.transitionTo('error');
        }
    }
    /**
     * 경고 추가
     */
    addWarning(warning) {
        this.dispatch({ type: 'ADD_WARNING', payload: warning });
    }
    /**
     * 워크플로우 완료
     */
    complete() {
        this.dispatch({ type: 'COMPLETE' });
    }
    /**
     * 상태 리셋
     */
    reset() {
        this.dispatch({ type: 'RESET' });
    }
    /**
     * 진행 상황 계산
     */
    getProgress() {
        const phaseSteps = {
            idle: { current: 0, total: 5, desc: 'Ready to start' },
            analyzing: { current: 1, total: 5, desc: 'Analyzing source workspace' },
            naming: { current: 2, total: 5, desc: 'Processing naming patterns' },
            planning: { current: 3, total: 5, desc: 'Creating execution plan' },
            building: { current: 4, total: 5, desc: 'Building entities in target' },
            validating: { current: 5, total: 5, desc: 'Validating results' },
            completed: { current: 5, total: 5, desc: 'Completed' },
            error: { current: -1, total: 5, desc: 'Error occurred' }
        };
        const step = phaseSteps[this.state.phase];
        return {
            phase: this.state.phase,
            currentStep: step.current,
            totalSteps: step.total,
            description: step.desc,
            percentage: step.current >= 0 ? Math.round((step.current / step.total) * 100) : 0
        };
    }
    /**
     * 상태 스냅샷 생성
     */
    createSnapshot() {
        return JSON.parse(JSON.stringify(this.state));
    }
    /**
     * 스냅샷에서 복원
     */
    restoreFromSnapshot(snapshot) {
        this.state = snapshot;
        this.notifyListeners();
    }
}
exports.WorkflowStateManager = WorkflowStateManager;
// ==================== Factory Functions ====================
const stateManagers = new Map();
function getStateManager(sessionId) {
    if (!stateManagers.has(sessionId)) {
        stateManagers.set(sessionId, new WorkflowStateManager(sessionId));
    }
    return stateManagers.get(sessionId);
}
function removeStateManager(sessionId) {
    stateManagers.delete(sessionId);
}
function clearAllStateManagers() {
    stateManagers.clear();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3JjaGVzdHJhdG9yL3N0YXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7OztBQWFILGdEQVVDO0FBSUQsMENBcUdDO0FBMklELDBDQUtDO0FBRUQsZ0RBRUM7QUFFRCxzREFFQztBQTdRRCwwREFBMEQ7QUFFMUQsU0FBZ0Isa0JBQWtCLENBQUMsU0FBaUI7SUFDbEQsT0FBTztRQUNMLFNBQVM7UUFDVCxLQUFLLEVBQUUsTUFBTTtRQUNiLGVBQWUsRUFBRSxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFO1FBQ3BFLGVBQWUsRUFBRSxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFO1FBQ3BFLGVBQWUsRUFBRSxFQUFFO1FBQ25CLE1BQU0sRUFBRSxFQUFFO1FBQ1YsUUFBUSxFQUFFLEVBQUU7S0FDYixDQUFDO0FBQ0osQ0FBQztBQUVELDBEQUEwRDtBQUUxRCxTQUFnQixlQUFlLENBQzdCLEtBQW9CLEVBQ3BCLE1BQXNCO0lBRXRCLFFBQVEsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3BCLEtBQUssT0FBTztZQUNWLE9BQU87Z0JBQ0wsR0FBRyxLQUFLO2dCQUNSLEtBQUssRUFBRSxXQUFXO2dCQUNsQixlQUFlLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNO2dCQUN0QyxlQUFlLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNO2dCQUN0QyxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7Z0JBQ25DLE1BQU0sRUFBRSxFQUFFO2dCQUNWLFFBQVEsRUFBRSxFQUFFO2FBQ2IsQ0FBQztRQUVKLEtBQUsscUJBQXFCO1lBQ3hCLE9BQU87Z0JBQ0wsR0FBRyxLQUFLO2dCQUNS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T0FBTyxhQUFhLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBRSxDQUFDO0FBQ3ZDLENBQUM7QUFFRCxTQUFnQixrQkFBa0IsQ0FBQyxTQUFpQjtJQUNsRCxhQUFhLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2xDLENBQUM7QUFFRCxTQUFnQixxQkFBcUI7SUFDbkMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ3hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogV29ya2Zsb3cgU3RhdGUgTWFuYWdlbWVudFxyXG4gKiDsm4ztgaztlIzroZzsmrAg7IOB7YOcIOq0gOumrCDrsI8g66as65OA7IScXHJcbiAqL1xyXG5cclxuaW1wb3J0IHtcclxuICBXb3JrZmxvd1N0YXRlLFxyXG4gIFdvcmtmbG93QWN0aW9uLFxyXG4gIFdvcmtmbG93UGhhc2UsXHJcbiAgV29ya2Zsb3dQcm9ncmVzcyxcclxuICBUYXJnZXRFbnRpdGllc1xyXG59IGZyb20gJy4uL3R5cGVzL3dvcmtmbG93JztcclxuaW1wb3J0IHsgQWdlbnRFcnJvciwgV29ya3NwYWNlQ29udGV4dCB9IGZyb20gJy4uL3R5cGVzL2FnZW50JztcclxuXHJcbi8vID09PT09PT09PT09PT09PT09PT09IEluaXRpYWwgU3RhdGUgPT09PT09PT09PT09PT09PT09PT1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVJbml0aWFsU3RhdGUoc2Vzc2lvbklkOiBzdHJpbmcpOiBXb3JrZmxvd1N0YXRlIHtcclxuICByZXR1cm4ge1xyXG4gICAgc2Vzc2lvbklkLFxyXG4gICAgcGhhc2U6ICdpZGxlJyxcclxuICAgIHNvdXJjZVdvcmtzcGFjZTogeyBhY2NvdW50SWQ6ICcnLCBjb250YWluZXJJZDogJycsIHdvcmtzcGFjZUlkOiAnJyB9LFxyXG4gICAgdGFyZ2V0V29ya3NwYWNlOiB7IGFjY291bnRJZDogJycsIGNvbnRhaW5lcklkOiAnJywgd29ya3NwYWNlSWQ6ICcnIH0sXHJcbiAgICBjcmVhdGVkRW50aXRpZXM6IFtdLFxyXG4gICAgZXJyb3JzOiBbXSxcclxuICAgIHdhcm5pbmdzOiBbXVxyXG4gIH07XHJcbn1cclxuXHJcbi8vID09PT09PT09PT09PT09PT09PT09IFN0YXRlIFJlZHVjZXIgPT09PT09PT09PT09PT09PT09PT1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB3b3JrZmxvd1JlZHVjZXIoXHJcbiAgc3RhdGU6IFdvcmtmbG93U3RhdGUsXHJcbiAgYWN0aW9uOiBXb3JrZmxvd0FjdGlvblxyXG4pOiBXb3JrZmxvd1N0YXRlIHtcclxuICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XHJcbiAgICBjYXNlICdTVEFSVCc6XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgLi4uc3RhdGUsXHJcbiAgICAgICAgcGhhc2U6ICdhbmFseXppbmcnLFxyXG4gICAgICAgIHNvdXJjZVdvcmtzcGFjZTogYWN0aW9uLnBheWxvYWQuc291cmNlLFxyXG4gICAgICAgIHRhcmdldFdvcmtzcGFjZTogYWN0aW9uLnBheWxvYWQudGFyZ2V0LFxyXG4gICAgICAgIHN0YXJ0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgICAgIGVycm9yczogW10sXHJcbiAgICAgICAgd2FybmluZ3M6IFtdXHJcbiAgICAgIH07XHJcblxyXG4gICAgY2FzZSAnU0VUX0FOQUxZU0lTX1JFU1VMVCc6XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgLi4uc3RhdGUsXHJcbiAgICAgICAgYW5hbHlzaXNSZXN1bHQ6IGFjdGlvbi5wYXlsb2FkXHJcbiAgICAgIH07XHJcblxyXG4gICAgY2FzZSAnU0VUX1NPVVJDRV9FTlRJVElFUyc6XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgLi4uc3RhdGUsXHJcbiAgICAgICAgc291cmNlRW50aXRpZXM6IGFjdGlvbi5wYXlsb2FkXHJcbiAgICAgIH07XHJcblxyXG4gICAgY2FzZSAnU0VUX1RBUkdFVF9FTlRJVElFUyc6XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgLi4uc3RhdGUsXHJcbiAgICAgICAgdGFyZ2V0RW50aXRpZXM6IGFjdGlvbi5wYXlsb2FkXHJcbiAgICAgIH07XHJcblxyXG4gICAgY2FzZSAnU0VUX05BTUlOR19QQVRURVJOJzpcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICAuLi5zdGF0ZSxcclxuICAgICAgICBuYW1pbmdQYXR0ZXJuOiBhY3Rpb24ucGF5bG9hZFxyXG4gICAgICB9O1xyXG5cclxuICAgIGNhc2UgJ1NFVF9FTlRJVFlfTkFNRV9NQVAnOlxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgIGVudGl0eU5hbWVNYXA6IGFjdGlvbi5wYXlsb2FkXHJcbiAgICAgIH07XHJcblxyXG4gICAgY2FzZSAnU0VUX0NSRUFUSU9OX1BMQU4nOlxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgIGNyZWF0aW9uUGxhbjogYWN0aW9uLnBheWxvYWRcclxuICAgICAgfTtcclxuXHJcbiAgICBjYXNlICdBRERfQ1JFQVRFRF9FTlRJVFknOlxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgIGNyZWF0ZWRFbnRpdGllczogWy4uLnN0YXRlLmNyZWF0ZWRFbnRpdGllcywgYWN0aW9uLnBheWxvYWRdXHJcbiAgICAgIH07XHJcblxyXG4gICAgY2FzZSAnU0VUX0lEX01BUFBJTkcnOlxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgIGlkTWFwcGluZzogYWN0aW9uLnBheWxvYWRcclxuICAgICAgfTtcclxuXHJcbiAgICBjYXNlICdTRVRfVkFMSURBVElPTl9SRVBPUlQnOlxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgIHZhbGlkYXRpb25SZXBvcnQ6IGFjdGlvbi5wYXlsb2FkXHJcbiAgICAgIH07XHJcblxyXG4gICAgY2FzZSAnQUREX0VSUk9SJzpcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICAuLi5zdGF0ZSxcclxuICAgICAgICBlcnJvcnM6IFsuLi5zdGF0ZS5lcnJvcnMsIGFjdGlvbi5wYXlsb2FkXVxyXG4gICAgICB9O1xyXG5cclxuICAgIGNhc2UgJ0FERF9XQVJOSU5HJzpcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICAuLi5zdGF0ZSxcclxuICAgICAgICB3YXJuaW5nczogWy4uLnN0YXRlLndhcm5pbmdzLCBhY3Rpb24ucGF5bG9hZF1cclxuICAgICAgfTtcclxuXHJcbiAgICBjYXNlICdUUkFOU0lUSU9OX1BIQVNFJzpcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICAuLi5zdGF0ZSxcclxuICAgICAgICBwaGFzZTogYWN0aW9uLnBheWxvYWRcclxuICAgICAgfTtcclxuXHJcbiAgICBjYXNlICdDT01QTEVURSc6XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgLi4uc3RhdGUsXHJcbiAgICAgICAgcGhhc2U6ICdjb21wbGV0ZWQnLFxyXG4gICAgICAgIGNvbXBsZXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgfTtcclxuXHJcbiAgICBjYXNlICdSRVNFVCc6XHJcbiAgICAgIHJldHVybiBjcmVhdGVJbml0aWFsU3RhdGUoc3RhdGUuc2Vzc2lvbklkKTtcclxuXHJcbiAgICBkZWZhdWx0OlxyXG4gICAgICByZXR1cm4gc3RhdGU7XHJcbiAgfVxyXG59XHJcblxyXG4vLyA9PT09PT09PT09PT09PT09PT09PSBTdGF0ZSBNYW5hZ2VyIENsYXNzID09PT09PT09PT09PT09PT09PT09XHJcblxyXG5leHBvcnQgY2xhc3MgV29ya2Zsb3dTdGF0ZU1hbmFnZXIge1xyXG4gIHByaXZhdGUgc3RhdGU6IFdvcmtmbG93U3RhdGU7XHJcbiAgcHJpdmF0ZSBsaXN0ZW5lcnM6IEFycmF5PChzdGF0ZTogV29ya2Zsb3dTdGF0ZSkgPT4gdm9pZD4gPSBbXTtcclxuXHJcbiAgY29uc3RydWN0b3Ioc2Vzc2lvbklkOiBzdHJpbmcpIHtcclxuICAgIHRoaXMuc3RhdGUgPSBjcmVhdGVJbml0aWFsU3RhdGUoc2Vzc2lvbklkKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIO2YhOyerCDsg4Htg5wg67CY7ZmYXHJcbiAgICovXHJcbiAgZ2V0U3RhdGUoKTogV29ya2Zsb3dTdGF0ZSB7XHJcbiAgICByZXR1cm4geyAuLi50aGlzLnN0YXRlIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDslaHshZgg65SU7Iqk7Yyo7LmYXHJcbiAgICovXHJcbiAgZGlzcGF0Y2goYWN0aW9uOiBXb3JrZmxvd0FjdGlvbik6IHZvaWQge1xyXG4gICAgdGhpcy5zdGF0ZSA9IHdvcmtmbG93UmVkdWNlcih0aGlzLnN0YXRlLCBhY3Rpb24pO1xyXG4gICAgdGhpcy5ub3RpZnlMaXN0ZW5lcnMoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOyDge2DnCDrs4Dqsr0g6rWs64+FXHJcbiAgICovXHJcbiAgc3Vic2NyaWJlKGxpc3RlbmVyOiAoc3RhdGU6IFdvcmtmbG93U3RhdGUpID0+IHZvaWQpOiAoKSA9PiB2b2lkIHtcclxuICAgIHRoaXMubGlzdGVuZXJzLnB1c2gobGlzdGVuZXIpO1xyXG4gICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgY29uc3QgaW5kZXggPSB0aGlzLmxpc3RlbmVycy5pbmRleE9mKGxpc3RlbmVyKTtcclxuICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xyXG4gICAgICAgIHRoaXMubGlzdGVuZXJzLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDrpqzsiqTrhIgg7JWM66a8XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBub3RpZnlMaXN0ZW5lcnMoKTogdm9pZCB7XHJcbiAgICBmb3IgKGNvbnN0IGxpc3RlbmVyIG9mIHRoaXMubGlzdGVuZXJzKSB7XHJcbiAgICAgIGxpc3RlbmVyKHRoaXMuZ2V0U3RhdGUoKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDsm4ztgaztlIzroZzsmrAg7Iuc7J6RXHJcbiAgICovXHJcbiAgc3RhcnQoc291cmNlOiBXb3Jrc3BhY2VDb250ZXh0LCB0YXJnZXQ6IFdvcmtzcGFjZUNvbnRleHQpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcGF0Y2goeyB0eXBlOiAnU1RBUlQnLCBwYXlsb2FkOiB7IHNvdXJjZSwgdGFyZ2V0IH0gfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDtjpjsnbTspogg7KCE7ZmYXHJcbiAgICovXHJcbiAgdHJhbnNpdGlvblRvKHBoYXNlOiBXb3JrZmxvd1BoYXNlKTogdm9pZCB7XHJcbiAgICB0aGlzLmRpc3BhdGNoKHsgdHlwZTogJ1RSQU5TSVRJT05fUEhBU0UnLCBwYXlsb2FkOiBwaGFzZSB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOyXkOufrCDstpTqsIBcclxuICAgKi9cclxuICBhZGRFcnJvcihlcnJvcjogQWdlbnRFcnJvcik6IHZvaWQge1xyXG4gICAgdGhpcy5kaXNwYXRjaCh7IHR5cGU6ICdBRERfRVJST1InLCBwYXlsb2FkOiBlcnJvciB9KTtcclxuICAgIGlmICghZXJyb3IucmVjb3ZlcmFibGUpIHtcclxuICAgICAgdGhpcy50cmFuc2l0aW9uVG8oJ2Vycm9yJyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDqsr3qs6Ag7LaU6rCAXHJcbiAgICovXHJcbiAgYWRkV2FybmluZyh3YXJuaW5nOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcGF0Y2goeyB0eXBlOiAnQUREX1dBUk5JTkcnLCBwYXlsb2FkOiB3YXJuaW5nIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog7JuM7YGs7ZSM66Gc7JqwIOyZhOujjFxyXG4gICAqL1xyXG4gIGNvbXBsZXRlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5kaXNwYXRjaCh7IHR5cGU6ICdDT01QTEVURScgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDsg4Htg5wg66as7IWLXHJcbiAgICovXHJcbiAgcmVzZXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmRpc3BhdGNoKHsgdHlwZTogJ1JFU0VUJyB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOynhO2WiSDsg4Htmakg6rOE7IKwXHJcbiAgICovXHJcbiAgZ2V0UHJvZ3Jlc3MoKTogV29ya2Zsb3dQcm9ncmVzcyB7XHJcbiAgICBjb25zdCBwaGFzZVN0ZXBzOiBSZWNvcmQ8V29ya2Zsb3dQaGFzZSwgeyBjdXJyZW50OiBudW1iZXI7IHRvdGFsOiBudW1iZXI7IGRlc2M6IHN0cmluZyB9PiA9IHtcclxuICAgICAgaWRsZTogeyBjdXJyZW50OiAwLCB0b3RhbDogNSwgZGVzYzogJ1JlYWR5IHRvIHN0YXJ0JyB9LFxyXG4gICAgICBhbmFseXppbmc6IHsgY3VycmVudDogMSwgdG90YWw6IDUsIGRlc2M6ICdBbmFseXppbmcgc291cmNlIHdvcmtzcGFjZScgfSxcclxuICAgICAgbmFtaW5nOiB7IGN1cnJlbnQ6IDIsIHRvdGFsOiA1LCBkZXNjOiAnUHJvY2Vzc2luZyBuYW1pbmcgcGF0dGVybnMnIH0sXHJcbiAgICAgIHBsYW5uaW5nOiB7IGN1cnJlbnQ6IDMsIHRvdGFsOiA1LCBkZXNjOiAnQ3JlYXRpbmcgZXhlY3V0aW9uIHBsYW4nIH0sXHJcbiAgICAgIGJ1aWxkaW5nOiB7IGN1cnJlbnQ6IDQsIHRvdGFsOiA1LCBkZXNjOiAnQnVpbGRpbmcgZW50aXRpZXMgaW4gdGFyZ2V0JyB9LFxyXG4gICAgICB2YWxpZGF0aW5nOiB7IGN1cnJlbnQ6IDUsIHRvdGFsOiA1LCBkZXNjOiAnVmFsaWRhdGluZyByZXN1bHRzJyB9LFxyXG4gICAgICBjb21wbGV0ZWQ6IHsgY3VycmVudDogNSwgdG90YWw6IDUsIGRlc2M6ICdDb21wbGV0ZWQnIH0sXHJcbiAgICAgIGVycm9yOiB7IGN1cnJlbnQ6IC0xLCB0b3RhbDogNSwgZGVzYzogJ0Vycm9yIG9jY3VycmVkJyB9XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHN0ZXAgPSBwaGFzZVN0ZXBzW3RoaXMuc3RhdGUucGhhc2VdO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgcGhhc2U6IHRoaXMuc3RhdGUucGhhc2UsXHJcbiAgICAgIGN1cnJlbnRTdGVwOiBzdGVwLmN1cnJlbnQsXHJcbiAgICAgIHRvdGFsU3RlcHM6IHN0ZXAudG90YWwsXHJcbiAgICAgIGRlc2NyaXB0aW9uOiBzdGVwLmRlc2MsXHJcbiAgICAgIHBlcmNlbnRhZ2U6IHN0ZXAuY3VycmVudCA+PSAwID8gTWF0aC5yb3VuZCgoc3RlcC5jdXJyZW50IC8gc3RlcC50b3RhbCkgKiAxMDApIDogMFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOyDge2DnCDsiqTrg4Xsg7cg7IOd7ISxXHJcbiAgICovXHJcbiAgY3JlYXRlU25hcHNob3QoKTogV29ya2Zsb3dTdGF0ZSB7XHJcbiAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLnN0YXRlKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDsiqTrg4Xsg7fsl5DshJwg67O17JuQXHJcbiAgICovXHJcbiAgcmVzdG9yZUZyb21TbmFwc2hvdChzbmFwc2hvdDogV29ya2Zsb3dTdGF0ZSk6IHZvaWQge1xyXG4gICAgdGhpcy5zdGF0ZSA9IHNuYXBzaG90O1xyXG4gICAgdGhpcy5ub3RpZnlMaXN0ZW5lcnMoKTtcclxuICB9XHJcbn1cclxuXHJcbi8vID09PT09PT09PT09PT09PT09PT09IEZhY3RvcnkgRnVuY3Rpb25zID09PT09PT09PT09PT09PT09PT09XHJcblxyXG5jb25zdCBzdGF0ZU1hbmFnZXJzID0gbmV3IE1hcDxzdHJpbmcsIFdvcmtmbG93U3RhdGVNYW5hZ2VyPigpO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFN0YXRlTWFuYWdlcihzZXNzaW9uSWQ6IHN0cmluZyk6IFdvcmtmbG93U3RhdGVNYW5hZ2VyIHtcclxuICBpZiAoIXN0YXRlTWFuYWdlcnMuaGFzKHNlc3Npb25JZCkpIHtcclxuICAgIHN0YXRlTWFuYWdlcnMuc2V0KHNlc3Npb25JZCwgbmV3IFdvcmtmbG93U3RhdGVNYW5hZ2VyKHNlc3Npb25JZCkpO1xyXG4gIH1cclxuICByZXR1cm4gc3RhdGVNYW5hZ2Vycy5nZXQoc2Vzc2lvbklkKSE7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiByZW1vdmVTdGF0ZU1hbmFnZXIoc2Vzc2lvbklkOiBzdHJpbmcpOiB2b2lkIHtcclxuICBzdGF0ZU1hbmFnZXJzLmRlbGV0ZShzZXNzaW9uSWQpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2xlYXJBbGxTdGF0ZU1hbmFnZXJzKCk6IHZvaWQge1xyXG4gIHN0YXRlTWFuYWdlcnMuY2xlYXIoKTtcclxufVxyXG4iXX0=