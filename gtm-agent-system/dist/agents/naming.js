"use strict";
/**
 * Naming Agent
 * 명명 패턴 분석 및 새 이름 생성
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.NamingAgent = void 0;
const gtm_agent_skills_1 = require("gtm-agent-skills");
const base_1 = require("./base");
// ==================== Naming Agent ====================
class NamingAgent extends base_1.BaseAgent {
    constructor() {
        super('naming');
        this.parser = new gtm_agent_skills_1.NamingParser();
    }
    /**
     * 요청 처리
     */
    async execute(request) {
        switch (request.action) {
            case 'extractPattern':
                return this.extractPattern(request.data);
            case 'generateNames':
                return this.generateNames(request.data);
            case 'analyzePatterns':
                return this.analyzePatterns(request.data);
            default:
                throw new Error(`Unknown action: ${request.action}`);
        }
    }
    /**
     * 이름 목록에서 패턴 추출
     */
    async extractPattern(request) {
        return this.safeExecute({ action: 'extractPattern', data: request, context: this.context }, async () => {
            this.logger.info('Extracting pattern', { count: request.names.length });
            const pattern = this.parser.extractPattern(request.names);
            if (pattern) {
                this.logger.info('Pattern extracted', {
                    separator: pattern.separator,
                    segments: pattern.segments.length,
                    confidence: pattern.confidence
                });
            }
            else {
                this.logger.warn('No pattern found');
            }
            return pattern;
        });
    }
    /**
     * 새 이름 생성
     */
    async generateNames(request) {
        return this.safeExecute({ action: 'generateNames', data: request, context: this.context }, async () => {
            const { sourceEntities, targetPattern, namePrefix, nameSuffix } = request;
            const nameMap = new Map();
            // 태그 이름 생성
            for (const tag of sourceEntities.tags) {
                const newName = this.generateEntityName(tag.name, targetPattern, namePrefix, nameSuffix);
                nameMap.set(tag.tagId, newName);
            }
            // 트리거 이름 생성
            for (const trigger of sourceEntities.triggers) {
                const newName = this.generateEntityName(trigger.name, targetPattern, namePrefix, nameSuffix);
                nameMap.set(trigger.triggerId, newName);
            }
            // 변수 이름 생성 (변수는 이름 기반 참조이므로 보통 유지)
            for (const variable of sourceEntities.variables) {
                const newName = this.generateEntityName(variable.name, targetPattern, namePrefix, nameSuffix);
                nameMap.set(variable.variableId, newName);
            }
            this.logger.info('Names generated', { count: nameMap.size });
            return {
                pattern: targetPattern,
                nameMap
            };
        });
    }
    /**
     * 전체 패턴 분석
     */
    async analyzePatterns(entities) {
        return this.safeExecute({ action: 'analyzePatterns', data: entities, context: this.context }, async () => {
            this.logger.info('Analyzing patterns for all entity types');
            // 태그 패턴 분석
            const tagNames = entities.tags.map(t => t.name);
            const tagPatterns = this.parser.extractPatternsByPrefix(tagNames, [
                'GA4', 'UA', 'FB', 'AD', 'HTML', 'cHTML'
            ]);
            // 트리거 패턴 분석
            const triggerNames = entities.triggers.map(t => t.name);
            const triggerPatterns = this.parser.extractPatternsByPrefix(triggerNames, [
                'CE', 'EV', 'Click', 'CL', 'Scroll', 'Timer'
            ]);
            // 변수 패턴 분석
            const variableNames = entities.variables.map(v => v.name);
            const variablePatterns = this.parser.extractPatternsByPrefix(variableNames, [
                'DLV', 'DL', 'JS', 'jsVar', 'Const', 'Lookup', 'Cookie'
            ]);
            this.logger.info('Pattern analysis completed', {
                tagPatterns: tagPatterns.size,
                triggerPatterns: triggerPatterns.size,
                variablePatterns: variablePatterns.size
            });
            return {
                tagPatterns,
                triggerPatterns,
                variablePatterns
            };
        });
    }
    /**
     * 엔티티 이름 생성
     */
    generateEntityName(originalName, pattern, prefix, suffix) {
        // 패턴이 있으면 패턴 기반 변환
        if (pattern) {
            const variables = this.parser.extractVariables(originalName, pattern);
            if (variables) {
                return this.parser.generateName(pattern, variables);
            }
        }
        // 단순 prefix/suffix 적용
        let newName = originalName;
        if (prefix)
            newName = `${prefix}${newName}`;
        if (suffix)
            newName = `${newName}${suffix}`;
        return newName;
    }
    /**
     * 표준 템플릿 반환
     */
    getStandardTemplates() {
        return gtm_agent_skills_1.GTM_NAMING_TEMPLATES;
    }
}
exports.NamingAgent = NamingAgent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmFtaW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2FnZW50cy9uYW1pbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7O0FBRUgsdURBUTBCO0FBQzFCLGlDQUFtQztBQTBCbkMseURBQXlEO0FBRXpELE1BQWEsV0FBWSxTQUFRLGdCQUFTO0lBR3hDO1FBQ0UsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2hCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSwrQkFBWSxFQUFFLENBQUM7SUFDbkMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLE9BQU8sQ0FBTyxPQUF3QjtRQUMxQyxRQUFRLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUN2QixLQUFLLGdCQUFnQjtnQkFDbkIsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUE2QixDQUE4QixDQUFDO1lBRWpHLEtBQUssZUFBZTtnQkFDbEIsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUE0QixDQUE4QixDQUFDO1lBRS9GLEtBQUssaUJBQWlCO2dCQUNwQixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLElBQTRFLENBQThCLENBQUM7WUFFako7Z0JBQ0UsTUFBTSxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDekQsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLEtBQUssQ0FBQyxjQUFjLENBQzFCLE9BQThCO1FBRTlCLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FDckIsRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQVEsRUFBRSxFQUNuRSxLQUFLLElBQUksRUFBRTtZQUNULElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFvQixF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QUFlLENBQUMsSUFBSTtnQkFDckMsZ0JBQWdCLEVBQUUsZ0JBQWdCLENBQUMsSUFBSTthQUN4QyxDQUFDLENBQUM7WUFFSCxPQUFPO2dCQUNMLFdBQVc7Z0JBQ1gsZUFBZTtnQkFDZixnQkFBZ0I7YUFDakIsQ0FBQztRQUNKLENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0ssa0JBQWtCLENBQ3hCLFlBQW9CLEVBQ3BCLE9BQXVCLEVBQ3ZCLE1BQWUsRUFDZixNQUFlO1FBRWYsbUJBQW1CO1FBQ25CLElBQUksT0FBTyxFQUFFLENBQUM7WUFDWixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQztZQUN0RSxJQUFJLFNBQVMsRUFBRSxDQUFDO2dCQUNkLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ3RELENBQUM7UUFDSCxDQUFDO1FBRUQsc0JBQXNCO1FBQ3RCLElBQUksT0FBTyxHQUFHLFlBQVksQ0FBQztRQUMzQixJQUFJLE1BQU07WUFBRSxPQUFPLEdBQUcsR0FBRyxNQUFNLEdBQUcsT0FBTyxFQUFFLENBQUM7UUFDNUMsSUFBSSxNQUFNO1lBQUUsT0FBTyxHQUFHLEdBQUcsT0FBTyxHQUFHLE1BQU0sRUFBRSxDQUFDO1FBRTVDLE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFRDs7T0FFRztJQUNILG9CQUFvQjtRQUNsQixPQUFPLHVDQUFvQixDQUFDO0lBQzlCLENBQUM7Q0FDRjtBQTdMRCxrQ0E2TEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogTmFtaW5nIEFnZW50XHJcbiAqIOuqheuqhSDtjKjthLQg67aE7ISdIOuwjyDsg4gg7J2066aEIOyDneyEsVxyXG4gKi9cclxuXHJcbmltcG9ydCB7XHJcbiAgTmFtaW5nUGFyc2VyLFxyXG4gIE5hbWluZ1BhdHRlcm4sXHJcbiAgR1RNVGFnLFxyXG4gIEdUTVRyaWdnZXIsXHJcbiAgR1RNVmFyaWFibGUsXHJcbiAgRW50aXR5VHlwZSxcclxuICBHVE1fTkFNSU5HX1RFTVBMQVRFU1xyXG59IGZyb20gJ2d0bS1hZ2VudC1za2lsbHMnO1xyXG5pbXBvcnQgeyBCYXNlQWdlbnQgfSBmcm9tICcuL2Jhc2UnO1xyXG5pbXBvcnQgeyBBZ2VudFJlcXVlc3QsIEFnZW50UmVzcG9uc2UgfSBmcm9tICcuLi90eXBlcy9hZ2VudCc7XHJcblxyXG4vLyA9PT09PT09PT09PT09PT09PT09PSBSZXF1ZXN0L1Jlc3BvbnNlIFR5cGVzID09PT09PT09PT09PT09PT09PT09XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEV4dHJhY3RQYXR0ZXJuUmVxdWVzdCB7XHJcbiAgbmFtZXM6IHN0cmluZ1tdO1xyXG4gIGVudGl0eVR5cGU/OiBFbnRpdHlUeXBlO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEdlbmVyYXRlTmFtZXNSZXF1ZXN0IHtcclxuICBzb3VyY2VFbnRpdGllczoge1xyXG4gICAgdGFnczogR1RNVGFnW107XHJcbiAgICB0cmlnZ2VyczogR1RNVHJpZ2dlcltdO1xyXG4gICAgdmFyaWFibGVzOiBHVE1WYXJpYWJsZVtdO1xyXG4gIH07XHJcbiAgdGFyZ2V0UGF0dGVybj86IE5hbWluZ1BhdHRlcm47XHJcbiAgbmFtZVByZWZpeD86IHN0cmluZztcclxuICBuYW1lU3VmZml4Pzogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIE5hbWluZ1Jlc3VsdCB7XHJcbiAgcGF0dGVybj86IE5hbWluZ1BhdHRlcm47XHJcbiAgbmFtZU1hcDogTWFwPHN0cmluZywgc3RyaW5nPjsgLy8gb3JpZ2luYWxJZCAtPiBuZXdOYW1lXHJcbn1cclxuXHJcbi8vID09PT09PT09PT09PT09PT09PT09IE5hbWluZyBBZ2VudCA9PT09PT09PT09PT09PT09PT09PVxyXG5cclxuZXhwb3J0IGNsYXNzIE5hbWluZ0FnZW50IGV4dGVuZHMgQmFzZUFnZW50IHtcclxuICBwcml2YXRlIHBhcnNlcjogTmFtaW5nUGFyc2VyO1xyXG5cclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHN1cGVyKCduYW1pbmcnKTtcclxuICAgIHRoaXMucGFyc2VyID0gbmV3IE5hbWluZ1BhcnNlcigpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog7JqU7LKtIOyymOumrFxyXG4gICAqL1xyXG4gIGFzeW5jIGV4ZWN1dGU8VCwgUj4ocmVxdWVzdDogQWdlbnRSZXF1ZXN0PFQ+KTogUHJvbWlzZTxBZ2VudFJlc3BvbnNlPFI+PiB7XHJcbiAgICBzd2l0Y2ggKHJlcXVlc3QuYWN0aW9uKSB7XHJcbiAgICAgIGNhc2UgJ2V4dHJhY3RQYXR0ZXJuJzpcclxuICAgICAgICByZXR1cm4gdGhpcy5leHRyYWN0UGF0dGVybihyZXF1ZXN0LmRhdGEgYXMgRXh0cmFjdFBhdHRlcm5SZXF1ZXN0KSBhcyBQcm9taXNlPEFnZW50UmVzcG9uc2U8Uj4+O1xyXG5cclxuICAgICAgY2FzZSAnZ2VuZXJhdGVOYW1lcyc6XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2VuZXJhdGVOYW1lcyhyZXF1ZXN0LmRhdGEgYXMgR2VuZXJhdGVOYW1lc1JlcXVlc3QpIGFzIFByb21pc2U8QWdlbnRSZXNwb25zZTxSPj47XHJcblxyXG4gICAgICBjYXNlICdhbmFseXplUGF0dGVybnMnOlxyXG4gICAgICAgIHJldHVybiB0aGlzLmFuYWx5emVQYXR0ZXJucyhyZXF1ZXN0LmRhdGEgYXMgeyB0YWdzOiBHVE1UYWdbXTsgdHJpZ2dlcnM6IEdUTVRyaWdnZXJbXTsgdmFyaWFibGVzOiBHVE1WYXJpYWJsZVtdIH0pIGFzIFByb21pc2U8QWdlbnRSZXNwb25zZTxSPj47XHJcblxyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBhY3Rpb246ICR7cmVxdWVzdC5hY3Rpb259YCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDsnbTrpoQg66qp66Gd7JeQ7IScIO2MqO2EtCDstpTstpxcclxuICAgKi9cclxuICBwcml2YXRlIGFzeW5jIGV4dHJhY3RQYXR0ZXJuKFxyXG4gICAgcmVxdWVzdDogRXh0cmFjdFBhdHRlcm5SZXF1ZXN0XHJcbiAgKTogUHJvbWlzZTxBZ2VudFJlc3BvbnNlPE5hbWluZ1BhdHRlcm4gfCBudWxsPj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuc2FmZUV4ZWN1dGUoXHJcbiAgICAgIHsgYWN0aW9uOiAnZXh0cmFjdFBhdHRlcm4nLCBkYXRhOiByZXF1ZXN0LCBjb250ZXh0OiB0aGlzLmNvbnRleHQhIH0sXHJcbiAgICAgIGFzeW5jICgpID0+IHtcclxuICAgICAgICB0aGlzLmxvZ2dlci5pbmZvKCdFeHRyYWN0aW5nIHBhdHRlcm4nLCB7IGNvdW50OiByZXF1ZXN0Lm5hbWVzLmxlbmd0aCB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgcGF0dGVybiA9IHRoaXMucGFyc2VyLmV4dHJhY3RQYXR0ZXJuKHJlcXVlc3QubmFtZXMpO1xyXG5cclxuICAgICAgICBpZiAocGF0dGVybikge1xyXG4gICAgICAgICAgdGhpcy5sb2dnZXIuaW5mbygnUGF0dGVybiBleHRyYWN0ZWQnLCB7XHJcbiAgICAgICAgICAgIHNlcGFyYXRvcjogcGF0dGVybi5zZXBhcmF0b3IsXHJcbiAgICAgICAgICAgIHNlZ21lbnRzOiBwYXR0ZXJuLnNlZ21lbnRzLmxlbmd0aCxcclxuICAgICAgICAgICAgY29uZmlkZW5jZTogcGF0dGVybi5jb25maWRlbmNlXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5sb2dnZXIud2FybignTm8gcGF0dGVybiBmb3VuZCcpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHBhdHRlcm47XHJcbiAgICAgIH1cclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDsg4gg7J2066aEIOyDneyEsVxyXG4gICAqL1xyXG4gIHByaXZhdGUgYXN5bmMgZ2VuZXJhdGVOYW1lcyhcclxuICAgIHJlcXVlc3Q6IEdlbmVyYXRlTmFtZXNSZXF1ZXN0XHJcbiAgKTogUHJvbWlzZTxBZ2VudFJlc3BvbnNlPE5hbWluZ1Jlc3VsdD4+IHtcclxuICAgIHJldHVybiB0aGlzLnNhZmVFeGVjdXRlKFxyXG4gICAgICB7IGFjdGlvbjogJ2dlbmVyYXRlTmFtZXMnLCBkYXRhOiByZXF1ZXN0LCBjb250ZXh0OiB0aGlzLmNvbnRleHQhIH0sXHJcbiAgICAgIGFzeW5jICgpID0+IHtcclxuICAgICAgICBjb25zdCB7IHNvdXJjZUVudGl0aWVzLCB0YXJnZXRQYXR0ZXJuLCBuYW1lUHJlZml4LCBuYW1lU3VmZml4IH0gPSByZXF1ZXN0O1xyXG4gICAgICAgIGNvbnN0IG5hbWVNYXAgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xyXG5cclxuICAgICAgICAvLyDtg5zqt7gg7J2066aEIOyDneyEsVxyXG4gICAgICAgIGZvciAoY29uc3QgdGFnIG9mIHNvdXJjZUVudGl0aWVzLnRhZ3MpIHtcclxuICAgICAgICAgIGNvbnN0IG5ld05hbWUgPSB0aGlzLmdlbmVyYXRlRW50aXR5TmFtZShcclxuICAgICAgICAgICAgdGFnLm5hbWUsXHJcbiAgICAgICAgICAgIHRhcmdldFBhdHRlcm4sXHJcbiAgICAgICAgICAgIG5hbWVQcmVmaXgsXHJcbiAgICAgICAgICAgIG5hbWVTdWZmaXhcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgICBuYW1lTWFwLnNldCh0YWcudGFnSWQsIG5ld05hbWUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g7Yq466as6rGwIOydtOumhCDsg53shLFcclxuICAgICAgICBmb3IgKGNvbnN0IHRyaWdnZXIgb2Ygc291cmNlRW50aXRpZXMudHJpZ2dlcnMpIHtcclxuICAgICAgICAgIGNvbnN0IG5ld05hbWUgPSB0aGlzLmdlbmVyYXRlRW50aXR5TmFtZShcclxuICAgICAgICAgICAgdHJpZ2dlci5uYW1lLFxyXG4gICAgICAgICAgICB0YXJnZXRQYXR0ZXJuLFxyXG4gICAgICAgICAgICBuYW1lUHJlZml4LFxyXG4gICAgICAgICAgICBuYW1lU3VmZml4XHJcbiAgICAgICAgICApO1xyXG4gICAgICAgICAgbmFtZU1hcC5zZXQodHJpZ2dlci50cmlnZ2VySWQsIG5ld05hbWUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g67OA7IiYIOydtOumhCDsg53shLEgKOuzgOyImOuKlCDsnbTrpoQg6riw67CYIOywuOyhsOydtOuvgOuhnCDrs7TthrUg7Jyg7KeAKVxyXG4gICAgICAgIGZvciAoY29uc3QgdmFyaWFibGUgb2Ygc291cmNlRW50aXRpZXMudmFyaWFibGVzKSB7XHJcbiAgICAgICAgICBjb25zdCBuZXdOYW1lID0gdGhpcy5nZW5lcmF0ZUVudGl0eU5hbWUoXHJcbiAgICAgICAgICAgIHZhcmlhYmxlLm5hbWUsXHJcbiAgICAgICAgICAgIHRhcmdldFBhdHRlcm4sXHJcbiAgICAgICAgICAgIG5hbWVQcmVmaXgsXHJcbiAgICAgICAgICAgIG5hbWVTdWZmaXhcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgICBuYW1lTWFwLnNldCh2YXJpYWJsZS52YXJpYWJsZUlkLCBuZXdOYW1lKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMubG9nZ2VyLmluZm8oJ05hbWVzIGdlbmVyYXRlZCcsIHsgY291bnQ6IG5hbWVNYXAuc2l6ZSB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIHBhdHRlcm46IHRhcmdldFBhdHRlcm4sXHJcbiAgICAgICAgICBuYW1lTWFwXHJcbiAgICAgICAgfTtcclxuICAgICAgfVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOyghOyytCDtjKjthLQg67aE7ISdXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhc3luYyBhbmFseXplUGF0dGVybnMoXHJcbiAgICBlbnRpdGllczogeyB0YWdzOiBHVE1UYWdbXTsgdHJpZ2dlcnM6IEdUTVRyaWdnZXJbXTsgdmFyaWFibGVzOiBHVE1WYXJpYWJsZVtdIH1cclxuICApOiBQcm9taXNlPEFnZW50UmVzcG9uc2U8e1xyXG4gICAgdGFnUGF0dGVybnM6IE1hcDxzdHJpbmcsIE5hbWluZ1BhdHRlcm4+O1xyXG4gICAgdHJpZ2dlclBhdHRlcm5zOiBNYXA8c3RyaW5nLCBOYW1pbmdQYXR0ZXJuPjtcclxuICAgIHZhcmlhYmxlUGF0dGVybnM6IE1hcDxzdHJpbmcsIE5hbWluZ1BhdHRlcm4+O1xyXG4gIH0+PiB7XHJcbiAgICByZXR1cm4gdGhpcy5zYWZlRXhlY3V0ZShcclxuICAgICAgeyBhY3Rpb246ICdhbmFseXplUGF0dGVybnMnLCBkYXRhOiBlbnRpdGllcywgY29udGV4dDogdGhpcy5jb250ZXh0ISB9LFxyXG4gICAgICBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2dnZXIuaW5mbygnQW5hbHl6aW5nIHBhdHRlcm5zIGZvciBhbGwgZW50aXR5IHR5cGVzJyk7XHJcblxyXG4gICAgICAgIC8vIO2DnOq3uCDtjKjthLQg67aE7ISdXHJcbiAgICAgICAgY29uc3QgdGFnTmFtZXMgPSBlbnRpdGllcy50YWdzLm1hcCh0ID0+IHQubmFtZSk7XHJcbiAgICAgICAgY29uc3QgdGFnUGF0dGVybnMgPSB0aGlzLnBhcnNlci5leHRyYWN0UGF0dGVybnNCeVByZWZpeCh0YWdOYW1lcywgW1xyXG4gICAgICAgICAgJ0dBNCcsICdVQScsICdGQicsICdBRCcsICdIVE1MJywgJ2NIVE1MJ1xyXG4gICAgICAgIF0pO1xyXG5cclxuICAgICAgICAvLyDtirjrpqzqsbAg7Yyo7YS0IOu2hOyEnVxyXG4gICAgICAgIGNvbnN0IHRyaWdnZXJOYW1lcyA9IGVudGl0aWVzLnRyaWdnZXJzLm1hcCh0ID0+IHQubmFtZSk7XHJcbiAgICAgICAgY29uc3QgdHJpZ2dlclBhdHRlcm5zID0gdGhpcy5wYXJzZXIuZXh0cmFjdFBhdHRlcm5zQnlQcmVmaXgodHJpZ2dlck5hbWVzLCBbXHJcbiAgICAgICAgICAnQ0UnLCAnRVYnLCAnQ2xpY2snLCAnQ0wnLCAnU2Nyb2xsJywgJ1RpbWVyJ1xyXG4gICAgICAgIF0pO1xyXG5cclxuICAgICAgICAvLyDrs4DsiJgg7Yyo7YS0IOu2hOyEnVxyXG4gICAgICAgIGNvbnN0IHZhcmlhYmxlTmFtZXMgPSBlbnRpdGllcy52YXJpYWJsZXMubWFwKHYgPT4gdi5uYW1lKTtcclxuICAgICAgICBjb25zdCB2YXJpYWJsZVBhdHRlcm5zID0gdGhpcy5wYXJzZXIuZXh0cmFjdFBhdHRlcm5zQnlQcmVmaXgodmFyaWFibGVOYW1lcywgW1xyXG4gICAgICAgICAgJ0RMVicsICdETCcsICdKUycsICdqc1ZhcicsICdDb25zdCcsICdMb29rdXAnLCAnQ29va2llJ1xyXG4gICAgICAgIF0pO1xyXG5cclxuICAgICAgICB0aGlzLmxvZ2dlci5pbmZvKCdQYXR0ZXJuIGFuYWx5c2lzIGNvbXBsZXRlZCcsIHtcclxuICAgICAgICAgIHRhZ1BhdHRlcm5zOiB0YWdQYXR0ZXJucy5zaXplLFxyXG4gICAgICAgICAgdHJpZ2dlclBhdHRlcm5zOiB0cmlnZ2VyUGF0dGVybnMuc2l6ZSxcclxuICAgICAgICAgIHZhcmlhYmxlUGF0dGVybnM6IHZhcmlhYmxlUGF0dGVybnMuc2l6ZVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgdGFnUGF0dGVybnMsXHJcbiAgICAgICAgICB0cmlnZ2VyUGF0dGVybnMsXHJcbiAgICAgICAgICB2YXJpYWJsZVBhdHRlcm5zXHJcbiAgICAgICAgfTtcclxuICAgICAgfVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOyXlO2LsO2LsCDsnbTrpoQg7IOd7ISxXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZW5lcmF0ZUVudGl0eU5hbWUoXHJcbiAgICBvcmlnaW5hbE5hbWU6IHN0cmluZyxcclxuICAgIHBhdHRlcm4/OiBOYW1pbmdQYXR0ZXJuLFxyXG4gICAgcHJlZml4Pzogc3RyaW5nLFxyXG4gICAgc3VmZml4Pzogc3RyaW5nXHJcbiAgKTogc3RyaW5nIHtcclxuICAgIC8vIO2MqO2EtOydtCDsnojsnLzrqbQg7Yyo7YS0IOq4sOuwmCDrs4DtmZhcclxuICAgIGlmIChwYXR0ZXJuKSB7XHJcbiAgICAgIGNvbnN0IHZhcmlhYmxlcyA9IHRoaXMucGFyc2VyLmV4dHJhY3RWYXJpYWJsZXMob3JpZ2luYWxOYW1lLCBwYXR0ZXJuKTtcclxuICAgICAgaWYgKHZhcmlhYmxlcykge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnBhcnNlci5nZW5lcmF0ZU5hbWUocGF0dGVybiwgdmFyaWFibGVzKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIOuLqOyInCBwcmVmaXgvc3VmZml4IOyggeyaqVxyXG4gICAgbGV0IG5ld05hbWUgPSBvcmlnaW5hbE5hbWU7XHJcbiAgICBpZiAocHJlZml4KSBuZXdOYW1lID0gYCR7cHJlZml4fSR7bmV3TmFtZX1gO1xyXG4gICAgaWYgKHN1ZmZpeCkgbmV3TmFtZSA9IGAke25ld05hbWV9JHtzdWZmaXh9YDtcclxuXHJcbiAgICByZXR1cm4gbmV3TmFtZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIO2RnOykgCDthZztlIzrpr8g67CY7ZmYXHJcbiAgICovXHJcbiAgZ2V0U3RhbmRhcmRUZW1wbGF0ZXMoKTogdHlwZW9mIEdUTV9OQU1JTkdfVEVNUExBVEVTIHtcclxuICAgIHJldHVybiBHVE1fTkFNSU5HX1RFTVBMQVRFUztcclxuICB9XHJcbn1cclxuIl19