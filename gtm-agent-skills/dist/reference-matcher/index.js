"use strict";
/**
 * Reference Matcher Skill
 *
 * GTM 엔티티 검색 및 유사도 계산
 * - 이름 기반 검색
 * - 타입/설정 기반 유사도 계산
 * - 유사 태그 추천
 *
 * @example
 * ```typescript
 * const matcher = new ReferenceMatcher(allTags, allVariables);
 *
 * // 이름으로 검색
 * const results = matcher.searchByName('purchase', { topK: 5 });
 *
 * // 유사 태그 찾기
 * const similar = matcher.findSimilarTags(referenceTag, { threshold: 0.7 });
 * ```
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.ReferenceMatcher = void 0;
exports.tagToSearchableText = tagToSearchableText;
exports.groupSimilarTags = groupSimilarTags;
// ==================== Reference Matcher ====================
class ReferenceMatcher {
    constructor(tags, triggers, variables) {
        this.tags = [];
        this.triggers = [];
        this.variables = [];
        if (tags)
            this.tags = tags;
        if (triggers)
            this.triggers = triggers;
        if (variables)
            this.variables = variables;
    }
    /**
     * 엔티티 목록 설정
     */
    setEntities(tags, triggers, variables) {
        this.tags = tags;
        this.triggers = triggers;
        this.variables = variables;
    }
    // ==================== Name-based Search ====================
    /**
     * 이름으로 태그 검색
     */
    searchTagsByName(query, options = {}) {
        const { topK = 10, threshold = 0, tagType } = options;
        const queryTokens = this.tokenize(query);
        return this.tags
            .filter(tag => !tagType || tag.type === tagType)
            .map(tag => {
            const { score, reasons } = this.calculateNameMatchScore(tag.name, query, queryTokens, this.getTagExtraText(tag));
            return { entity: tag, score, matchReasons: reasons };
        })
            .filter(r => r.score > threshold)
            .sort((a, b) => b.score - a.score)
            .slice(0, topK);
    }
    /**
     * 이름으로 변수 검색
     */
    searchVariablesByName(query, options = {}) {
        const { topK = 10, threshold = 0, variableType } = options;
        const queryTokens = this.tokenize(query);
        return this.variables
            .filter(v => !variableType || v.type === variableType)
            .map(variable => {
            const { score, reasons } = this.calculateNameMatchScore(variable.name, query, queryTokens);
            return { entity: variable, score, matchReasons: reasons };
        })
            .filter(r => r.score > threshold)
            .sort((a, b) => b.score - a.score)
            .slice(0, topK);
    }
    /**
     * 이름으로 트리거 검색
     */
    searchTriggersByName(query, options = {}) {
        const { topK = 10, threshold = 0 } = options;
        const queryTokens = this.tokenize(query);
        return this.triggers
            .map(trigger => {
            const { score, reasons } = this.calculateNameMatchScore(trigger.name, query, queryTokens);
            return { entity: trigger, score, matchReasons: reasons };
        })
            .filter(r => r.score > threshold)
            .sort((a, b) => b.score - a.score)
            .slice(0, topK);
    }
    // ==================== Similarity-based Search ====================
    /**
     * 유사한 태그 찾기
     */
    findSimilarTags(reference, options = {}) {
        const { considerName = true, considerType = true, considerParameters = true, threshold = 0.5 } = options;
        return this.tags
            .filter(tag => tag.tagId !== reference.tagId)
            .map(tag => {
            const { score, reasons } = this.calculateTagSimilarity(reference, tag, { considerName, considerType, considerParameters });
            return { entity: tag, score, matchReasons: reasons };
        })
            .filter(r => r.score >= threshold)
            .sort((a, b) => b.score - a.score);
    }
    /**
     * 특정 타입의 태그 찾기 (GA4 이벤트 등)
     */
    findTagsByType(tagType) {
        return this.tags.filter(tag => tag.type === tagType);
    }
    /**
     * GA4 이벤트 이름으로 태그 찾기
     */
    findGA4TagsByEventName(eventName) {
        return this.tags.filter(tag => {
            if (tag.type !== 'gaawe')
                return false;
            const eventNameParam = tag.parameter?.find(p => p.key === 'eventName');
            if (!eventNameParam?.value)
                return false;
            return eventNameParam.value.toLowerCase().includes(eventName.toLowerCase());
        });
    }
    /**
     * 정확한 이름으로 찾기
     */
    findTagByExactName(name) {
        return this.tags.find(t => t.name === name);
    }
    findVariableByExactName(name) {
        return this.variables.find(v => v.name === name);
    }
    findTriggerByExactName(name) {
        return this.triggers.find(t => t.name === name);
    }
    // ==================== Private Methods ====================
    /**
     * 이름 매칭 점수 계산
     */
    calculateNameMatchScore(name, query, queryTokens, extraText) {
        let score = 0;
        const reasons = [];
        const nameLower = name.toLowerCase();
        const queryLower = query.toLowerCase();
        // 1. 정확한 이름 매칭 (100점)
        if (nameLower === queryLower) {
            score += 100;
            reasons.push('exact match');
        }
        // 2. 이름에 검색어 포함 (50점)
        else if (nameLower.includes(queryLower)) {
            score += 50;
            reasons.push('contains query');
        }
        // 3. 토큰 매칭 (최대 30점)
        const nameTokens = this.tokenize(name);
        let matchedTokens = 0;
        for (const queryToken of queryTokens) {
            for (const nameToken of nameTokens) {
                if (nameToken.includes(queryToken) || queryToken.includes(nameToken)) {
                    matchedTokens++;
                    break;
                }
            }
        }
        if (matchedTokens > 0 && queryTokens.length > 0) {
            const tokenScore = (matchedTokens / queryTokens.length) * 30;
            score += tokenScore;
            reasons.push(`${matchedTokens}/${queryTokens.length} tokens`);
        }
        // 4. 추가 텍스트 매칭 (10점)
        if (extraText && extraText.toLowerCase().includes(queryLower)) {
            score += 10;
            reasons.push('extra text match');
        }
        return { score, reasons };
    }
    /**
     * 태그 유사도 계산
     */
    calculateTagSimilarity(reference, target, options) {
        let totalWeight = 0;
        let totalScore = 0;
        const reasons = [];
        // 1. 타입 유사도 (40%)
        if (options.considerType) {
            totalWeight += 40;
            if (reference.type === target.type) {
                totalScore += 40;
                reasons.push('same type');
            }
        }
        // 2. 이름 유사도 (30%)
        if (options.considerName) {
            totalWeight += 30;
            const nameSimilarity = this.calculateStringSimilarity(reference.name, target.name);
            totalScore += nameSimilarity * 30;
            if (nameSimilarity > 0.5) {
                reasons.push(`name similarity: ${(nameSimilarity * 100).toFixed(0)}%`);
            }
        }
        // 3. 파라미터 유사도 (30%)
        if (options.considerParameters && reference.parameter && target.parameter) {
            totalWeight += 30;
            const paramSimilarity = this.calculateParameterSimilarity(reference.parameter, target.parameter);
            totalScore += paramSimilarity * 30;
            if (paramSimilarity > 0.5) {
                reasons.push(`param similarity: ${(paramSimilarity * 100).toFixed(0)}%`);
            }
        }
        const finalScore = totalWeight > 0 ? totalScore / totalWeight : 0;
        return { score: finalScore, reasons };
    }
    /**
     * 문자열 유사도 (Jaccard similarity)
     */
    calculateStringSimilarity(a, b) {
        const tokensA = new Set(this.tokenize(a));
        const tokensB = new Set(this.tokenize(b));
        const intersection = new Set([...tokensA].filter(x => tokensB.has(x)));
        const union = new Set([...tokensA, ...tokensB]);
        if (union.size === 0)
            return 0;
        return intersection.size / union.size;
    }
    /**
     * 파라미터 유사도
     */
    calculateParameterSimilarity(paramsA, paramsB) {
        const keysA = new Set(paramsA.map(p => p.key));
        const keysB = new Set(paramsB.map(p => p.key));
        const intersection = new Set([...keysA].filter(x => keysB.has(x)));
        const union = new Set([...keysA, ...keysB]);
        if (union.size === 0)
            return 0;
        return intersection.size / union.size;
    }
    /**
     * 텍스트 토큰화
     */
    tokenize(text) {
        return text
            .toLowerCase()
            .split(/[\s\-_\.]+/)
            .filter(token => token.length > 1);
    }
    /**
     * 태그에서 추가 검색 텍스트 추출
     */
    getTagExtraText(tag) {
        const parts = [];
        // 이벤트 이름
        const eventNameParam = tag.parameter?.find(p => p.key === 'eventName');
        if (eventNameParam?.value) {
            parts.push(eventNameParam.value);
        }
        // Notes
        if (tag.notes) {
            parts.push(tag.notes);
        }
        return parts.join(' ');
    }
}
exports.ReferenceMatcher = ReferenceMatcher;
// ==================== Utility Functions ====================
/**
 * 태그를 검색 가능한 텍스트로 변환
 */
function tagToSearchableText(tag) {
    const parts = [tag.name, tag.type];
    const eventNameParam = tag.parameter?.find(p => p.key === 'eventName');
    if (eventNameParam?.value) {
        parts.push(eventNameParam.value);
    }
    if (tag.notes) {
        parts.push(tag.notes);
    }
    return parts.join(' ');
}
/**
 * 유사도 기반 태그 그룹핑
 */
function groupSimilarTags(tags, threshold = 0.7) {
    const groups = new Map();
    const assigned = new Set();
    for (const tag of tags) {
        if (assigned.has(tag.tagId))
            continue;
        const groupKey = tag.tagId;
        const group = [tag];
        assigned.add(tag.tagId);
        const matcher = new ReferenceMatcher([tag], [], []);
        matcher.setEntities(tags, [], []);
        const similar = matcher.findSimilarTags(tag, { threshold });
        for (const result of similar) {
            if (!assigned.has(result.entity.tagId)) {
                group.push(result.entity);
                assigned.add(result.entity.tagId);
            }
        }
        groups.set(groupKey, group);
    }
    return groups;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcmVmZXJlbmNlLW1hdGNoZXIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FrQkc7OztBQXFYSCxrREFhQztBQUtELDRDQThCQztBQTNZRCw4REFBOEQ7QUFFOUQsTUFBYSxnQkFBZ0I7SUFLM0IsWUFDRSxJQUFlLEVBQ2YsUUFBdUIsRUFDdkIsU0FBeUI7UUFQbkIsU0FBSSxHQUFhLEVBQUUsQ0FBQztRQUNwQixhQUFRLEdBQWlCLEVBQUUsQ0FBQztRQUM1QixjQUFTLEdBQWtCLEVBQUUsQ0FBQztRQU9wQyxJQUFJLElBQUk7WUFBRSxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUMzQixJQUFJLFFBQVE7WUFBRSxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN2QyxJQUFJLFNBQVM7WUFBRSxJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztJQUM1QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxXQUFXLENBQ1QsSUFBYyxFQUNkLFFBQXNCLEVBQ3RCLFNBQXdCO1FBRXhCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQzdCLENBQUM7SUFFRCw4REFBOEQ7SUFFOUQ7O09BRUc7SUFDSCxnQkFBZ0IsQ0FDZCxLQUFhLEVBQ2IsVUFBeUIsRUFBRTtRQUUzQixNQUFNLEVBQUUsSUFBSSxHQUFHLEVBQUUsRUFBRSxTQUFTLEdBQUcsQ0FBQyxFQUFFLE9BQU8sRUFBRSxHQUFHLE9BQU8sQ0FBQztRQUN0RCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXpDLE9BQU8sSUFBSSxDQUFDLElBQUk7YUFDYixNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxHQUFHLENBQUMsSUFBSSxLQUFLLE9BQU8sQ0FBQzthQUMvQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDVCxNQUFNLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FDckQsR0FBRyxDQUFDLElBQUksRUFDUixLQUFLLEVBQ0wsV0FBVyxFQUNYLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQzFCLENBQUM7WUFDRixPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxDQUFDO1FBQ3ZELENBQUMsQ0FBQzthQUNELE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDO2FBQ2hDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQzthQUNqQyxLQUFLLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3BCLENBQUM7SUFFRDs7T0FFRztJQUNILHFCQUFxQixDQUNuQixLQUFhLEVBQ2IsVUFBeUIsRUFBRTtRQUUzQixNQUFNLEVBQUUsSUFBSSxHQUFHLEVBQUUsRUFBRSxTQUFTLEdBQUcsQ0FBQyxFQUFFLFlBQVksRUFBRSxHQUFHLE9BQU8sQ0FBQztRQUMzRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXpDLE9BQU8sSUFBSSxDQUFDLFNBQVM7YUFDbEIsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxZQUFZLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxZQUFZLENBQUM7YUFDckQsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ2QsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQ3JELFFBQVEsQ0FBQyxJQUFJLEVBQ2IsS0FBSyxFQUNMLFdBQVcsQ0FDWixDQUFDO1lBQ0YsT0FBTyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsQ0FBQztRQUM1RCxDQUFDLENBQUM7YUFDRCxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQzthQUNoQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUM7YUFDakMsS0FBSyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxvQkFBb0IsQ0FDbEIsS0FBYSxFQUNiLFVBQXlCLEVBQUU7UUFFM0IsTUFBTSxFQUFFLElBQUksR0FBRyxFQUFFLEVBQUUsU0FBUyxHQUFHLENBQUMsRUFBRSxHQUFHLE9BQU8sQ0FBQztRQUM3QyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXpDLE9BQU8sSUFBSSxDQUFDLFFBQVE7YUFDakIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ2IsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQ3JELE9BQU8sQ0FBQyxJQUFJLEVBQ1osS0FBSyxFQUNMLFdBQVcsQ0FDWixDQUFDO1lBQ0YsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsQ0FBQztRQUMzRCxDQUFDLENBQUM7YUFDRCxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQzthQUNoQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUM7YUFDakMsS0FBSyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBRUQsb0VBQW9FO0lBRXBFOztPQUVHO0lBQ0gsZUFBZSxDQUNiLFNBQWlCLEVBQ2pCLFVBQTZCLEVBQUU7UUFFL0IsTUFBTSxFQUNKLFlBQVksR0FBRyxJQUFJLEVBQ25CLFlBQVksR0FBRyxJQUFJLEVBQ25CLGtCQUFrQixHQUFHLElBQUksRUFDekIsU0FBUyxHQUFHLEdBQUcsRUFDaEIsR0FBRyxPQUFPLENBQUM7UUFFWixPQUFPLElBQUksQ0FBQyxJQUFJO2FBQ2IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUMsS0FBSyxDQUFDO2FBQzVDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUNULE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUNwRCxTQUFTLEVBQ1QsR0FBRyxFQUNILEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxrQkFBa0IsRUFBRSxDQUNuRCxDQUFDO1lBQ0YsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsQ0FBQztRQUN2RCxDQUFDLENBQUM7YUFDRCxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLFNBQVMsQ0FBQzthQUNqQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxjQUFjLENBQUMsT0FBZTtRQUM1QixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksS0FBSyxPQUFPLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxzQkFBc0IsQ0FBQyxTQUFpQjtRQUN0QyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzVCLElBQUksR0FBRyxDQUFDLElBQUksS0FBSyxPQUFPO2dCQUFFLE9BQU8sS0FBSyxDQUFDO1lBRXZDLE1BQU0sY0FBYyxHQUFHLEdBQUcsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxXQUFXLENBQUMsQ0FBQztZQUN2RSxJQUFJLENBQUMsY0FBYyxFQUFFLEtBQUs7Z0JBQUUsT0FBTyxLQUFLLENBQUM7WUFFekMsT0FBTyxjQUFjLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUM5RSxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNILGtCQUFrQixDQUFDLElBQVk7UUFDN0IsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVELHVCQUF1QixDQUFDLElBQVk7UUFDbEMsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVELHNCQUFzQixDQUFDLElBQVk7UUFDakMsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVELDREQUE0RDtJQUU1RDs7T0FFRztJQUNLLHVCQUF1QixDQUM3QixJQUFZLEVBQ1osS0FBYSxFQUNiLFdBQXFCLEVBQ3JCLFNBQWtCO1FBRWxCLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztRQUNkLE1BQU0sT0FBTyxHQUFhLEVBQUUsQ0FBQztRQUU3QixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDckMsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRXZDLHNCQUFzQjtRQUN0QixJQUFJLFNBQVMsS0FBSyxVQUFVLEVBQUUsQ0FBQztZQUM3QixLQUFLLElBQUksR0FBRyxDQUFDO1lBQ2IsT0FBTyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUM5QixDQUFDO1FBQ0Qsc0JBQXNCO2FBQ2pCLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO1lBQ3hDLEtBQUssSUFBSSxFQUFFLENBQUM7WUFDWixPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDakMsQ0FBQztRQUVELG9CQUFvQjtRQUNwQixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZDLElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQztRQUV0QixLQUFLLE1BQU0sVUFBVSxJQUFJLFdBQVcsRUFBRSxDQUFDO1lBQ3JDLEtBQUssTUFBTSxTQUFTLElBQUksVUFBVSxFQUFFLENBQUM7Z0JBQ25DLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxVQUFVLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7b0JBQ3JFLGFBQWEsRUFBRSxDQUFDO29CQUNoQixNQUFNO2dCQUNSLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztRQUVELElBQUksYUFBYSxHQUFHLENBQUMsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ2hELE1BQU0sVUFBVSxHQUFHLENBQUMsYUFBYSxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDN0QsS0FBSyxJQUFJLFVBQVUsQ0FBQztZQUNwQixPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsYUFBYSxJQUFJLFdBQVcsQ0FBQyxNQUFNLFNBQVMsQ0FBQyxDQUFDO1FBQ2hFLENBQUM7UUFFRCxxQkFBcUI7UUFDckIsSUFBSSxTQUFTLElBQUksU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO1lBQzlELEtBQUssSUFBSSxFQUFFLENBQUM7WUFDWixPQUFPLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDbkMsQ0FBQztRQUVELE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssc0JBQXNCLENBQzVCLFNBQWlCLEVBQ2pCLE1BQWMsRUFDZCxPQUFzRjtRQUV0RixJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUM7UUFDcEIsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLE1BQU0sT0FBTyxHQUFhLEVBQUUsQ0FBQztRQUU3QixrQkFBa0I7UUFDbEIsSUFBSSxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDekIsV0FBVyxJQUFJLEVBQUUsQ0FBQztZQUNsQixJQUFJLFNBQVMsQ0FBQyxJQUFJLEtBQUssTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNuQyxVQUFVLElBQUksRUFBRSxDQUFDO2dCQUNqQixPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzVCLENBQUM7UUFDSCxDQUFDO1FBRUQsa0JBQWtCO1FBQ2xCLElBQUksT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3pCLFdBQVcsSUFBSSxFQUFFLENBQUM7WUFDbEIsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLHlCQUF5QixDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ25GLFVBQVUsSUFBSSxjQUFjLEdBQUcsRUFBRSxDQUFDO1lBQ2xDLElBQUksY0FBYyxHQUFHLEdBQUcsRUFBRSxDQUFDO2dCQUN6QixPQUFPLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGNBQWMsR0FBRyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3pFLENBQUM7UUFDSCxDQUFDO1FBRUQsb0JBQW9CO1FBQ3BCLElBQUksT0FBTyxDQUFDLGtCQUFrQixJQUFJLFNBQVMsQ0FBQyxTQUFTLElBQUksTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQzFFLFdBQVcsSUFBSSxFQUFFLENBQUM7WUFDbEIsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLDRCQUE0QixDQUN2RCxTQUFTLENBQUMsU0FBUyxFQUNuQixNQUFNLENBQUMsU0FBUyxDQUNqQixDQUFDO1lBQ0YsVUFBVSxJQUFJLGVBQWUsR0FBRyxFQUFFLENBQUM7WUFDbkMsSUFBSSxlQUFlLEdBQUcsR0FBRyxFQUFFLENBQUM7Z0JBQzFCLE9BQU8sQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsZUFBZSxHQUFHLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDM0UsQ0FBQztRQUNILENBQUM7UUFFRCxNQUFNLFVBQVUsR0FBRyxXQUFXLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFbEUsT0FBTyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLENBQUM7SUFDeEMsQ0FBQztJQUVEOztPQUVHO0lBQ0sseUJBQXlCLENBQUMsQ0FBUyxFQUFFLENBQVM7UUFDcEQsTUFBTSxPQUFPLEdBQUcsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzFDLE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUUxQyxNQUFNLFlBQVksR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkUsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLE9BQU8sRUFBRSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFFaEQsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUM7WUFBRSxPQUFPLENBQUMsQ0FBQztRQUUvQixPQUFPLFlBQVksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQztJQUN4QyxDQUFDO0lBRUQ7O09BRUc7SUFDSyw0QkFBNEIsQ0FDbEMsT0FBdUIsRUFDdkIsT0FBdUI7UUFFdkIsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQy9DLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUUvQyxNQUFNLFlBQVksR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkUsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLEtBQUssRUFBRSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFFNUMsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUM7WUFBRSxPQUFPLENBQUMsQ0FBQztRQUUvQixPQUFP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SSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUN2QyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDMUIsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3BDLENBQUM7UUFDSCxDQUFDO1FBRUQsTUFBTSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUVELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogUmVmZXJlbmNlIE1hdGNoZXIgU2tpbGxcclxuICpcclxuICogR1RNIOyXlO2LsO2LsCDqsoDsg4kg67CPIOycoOyCrOuPhCDqs4TsgrBcclxuICogLSDsnbTrpoQg6riw67CYIOqygOyDiVxyXG4gKiAtIO2DgOyehS/shKTsoJUg6riw67CYIOycoOyCrOuPhCDqs4TsgrBcclxuICogLSDsnKDsgqwg7YOc6re4IOy2lOyynFxyXG4gKlxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGB0eXBlc2NyaXB0XHJcbiAqIGNvbnN0IG1hdGNoZXIgPSBuZXcgUmVmZXJlbmNlTWF0Y2hlcihhbGxUYWdzLCBhbGxWYXJpYWJsZXMpO1xyXG4gKlxyXG4gKiAvLyDsnbTrpoTsnLzroZwg6rKA7IOJXHJcbiAqIGNvbnN0IHJlc3VsdHMgPSBtYXRjaGVyLnNlYXJjaEJ5TmFtZSgncHVyY2hhc2UnLCB7IHRvcEs6IDUgfSk7XHJcbiAqXHJcbiAqIC8vIOycoOyCrCDtg5zqt7gg7LC+6riwXHJcbiAqIGNvbnN0IHNpbWlsYXIgPSBtYXRjaGVyLmZpbmRTaW1pbGFyVGFncyhyZWZlcmVuY2VUYWcsIHsgdGhyZXNob2xkOiAwLjcgfSk7XHJcbiAqIGBgYFxyXG4gKi9cclxuXHJcbmltcG9ydCB7IEdUTVRhZywgR1RNVHJpZ2dlciwgR1RNVmFyaWFibGUsIEdUTVBhcmFtZXRlciB9IGZyb20gJy4uL3R5cGVzL2d0bSc7XHJcblxyXG4vLyA9PT09PT09PT09PT09PT09PT09PSBUeXBlcyA9PT09PT09PT09PT09PT09PT09PVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTZWFyY2hSZXN1bHQ8VD4ge1xyXG4gIGVudGl0eTogVDtcclxuICBzY29yZTogbnVtYmVyO1xyXG4gIG1hdGNoUmVhc29uczogc3RyaW5nW107XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU2VhcmNoT3B0aW9ucyB7XHJcbiAgdG9wSz86IG51bWJlcjtcclxuICB0aHJlc2hvbGQ/OiBudW1iZXI7XHJcbiAgdGFnVHlwZT86IHN0cmluZztcclxuICB2YXJpYWJsZVR5cGU/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU2ltaWxhcml0eU9wdGlvbnMge1xyXG4gIGNvbnNpZGVyTmFtZT86IGJvb2xlYW47XHJcbiAgY29uc2lkZXJUeXBlPzogYm9vbGVhbjtcclxuICBjb25zaWRlclBhcmFtZXRlcnM/OiBib29sZWFuO1xyXG4gIHRocmVzaG9sZD86IG51bWJlcjtcclxufVxyXG5cclxuLy8gPT09PT09PT09PT09PT09PT09PT0gUmVmZXJlbmNlIE1hdGNoZXIgPT09PT09PT09PT09PT09PT09PT1cclxuXHJcbmV4cG9ydCBjbGFzcyBSZWZlcmVuY2VNYXRjaGVyIHtcclxuICBwcml2YXRlIHRhZ3M6IEdUTVRhZ1tdID0gW107XHJcbiAgcHJpdmF0ZSB0cmlnZ2VyczogR1RNVHJpZ2dlcltdID0gW107XHJcbiAgcHJpdmF0ZSB2YXJpYWJsZXM6IEdUTVZhcmlhYmxlW10gPSBbXTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICB0YWdzPzogR1RNVGFnW10sXHJcbiAgICB0cmlnZ2Vycz86IEdUTVRyaWdnZXJbXSxcclxuICAgIHZhcmlhYmxlcz86IEdUTVZhcmlhYmxlW11cclxuICApIHtcclxuICAgIGlmICh0YWdzKSB0aGlzLnRhZ3MgPSB0YWdzO1xyXG4gICAgaWYgKHRyaWdnZXJzKSB0aGlzLnRyaWdnZXJzID0gdHJpZ2dlcnM7XHJcbiAgICBpZiAodmFyaWFibGVzKSB0aGlzLnZhcmlhYmxlcyA9IHZhcmlhYmxlcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOyXlO2LsO2LsCDrqqnroZ0g7ISk7KCVXHJcbiAgICovXHJcbiAgc2V0RW50aXRpZXMoXHJcbiAgICB0YWdzOiBHVE1UYWdbXSxcclxuICAgIHRyaWdnZXJzOiBHVE1UcmlnZ2VyW10sXHJcbiAgICB2YXJpYWJsZXM6IEdUTVZhcmlhYmxlW11cclxuICApOiB2b2lkIHtcclxuICAgIHRoaXMudGFncyA9IHRhZ3M7XHJcbiAgICB0aGlzLnRyaWdnZXJzID0gdHJpZ2dlcnM7XHJcbiAgICB0aGlzLnZhcmlhYmxlcyA9IHZhcmlhYmxlcztcclxuICB9XHJcblxyXG4gIC8vID09PT09PT09PT09PT09PT09PT09IE5hbWUtYmFzZWQgU2VhcmNoID09PT09PT09PT09PT09PT09PT09XHJcblxyXG4gIC8qKlxyXG4gICAqIOydtOumhOycvOuhnCDtg5zqt7gg6rKA7IOJXHJcbiAgICovXHJcbiAgc2VhcmNoVGFnc0J5TmFtZShcclxuICAgIHF1ZXJ5OiBzdHJpbmcsXHJcbiAgICBvcHRpb25zOiBTZWFyY2hPcHRpb25zID0ge31cclxuICApOiBTZWFyY2hSZXN1bHQ8R1RNVGFnPltdIHtcclxuICAgIGNvbnN0IHsgdG9wSyA9IDEwLCB0aHJlc2hvbGQgPSAwLCB0YWdUeXBlIH0gPSBvcHRpb25zO1xyXG4gICAgY29uc3QgcXVlcnlUb2tlbnMgPSB0aGlzLnRva2VuaXplKHF1ZXJ5KTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy50YWdzXHJcbiAgICAgIC5maWx0ZXIodGFnID0+ICF0YWdUeXBlIHx8IHRhZy50eXBlID09PSB0YWdUeXBlKVxyXG4gICAgICAubWFwKHRhZyA9PiB7XHJcbiAgICAgICAgY29uc3QgeyBzY29yZSwgcmVhc29ucyB9ID0gdGhpcy5jYWxjdWxhdGVOYW1lTWF0Y2hTY29yZShcclxuICAgICAgICAgIHRhZy5uYW1lLFxyXG4gICAgICAgICAgcXVlcnksXHJcbiAgICAgICAgICBxdWVyeVRva2VucyxcclxuICAgICAgICAgIHRoaXMuZ2V0VGFnRXh0cmFUZXh0KHRhZylcclxuICAgICAgICApO1xyXG4gICAgICAgIHJldHVybiB7IGVudGl0eTogdGFnLCBzY29yZSwgbWF0Y2hSZWFzb25zOiByZWFzb25zIH07XHJcbiAgICAgIH0pXHJcbiAgICAgIC5maWx0ZXIociA9PiByLnNjb3JlID4gdGhyZXNob2xkKVxyXG4gICAgICAuc29ydCgoYSwgYikgPT4gYi5zY29yZSAtIGEuc2NvcmUpXHJcbiAgICAgIC5zbGljZSgwLCB0b3BLKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOydtOumhOycvOuhnCDrs4DsiJgg6rKA7IOJXHJcbiAgICovXHJcbiAgc2VhcmNoVmFyaWFibGVzQnlOYW1lKFxyXG4gICAgcXVlcnk6IHN0cmluZyxcclxuICAgIG9wdGlvbnM6IFNlYXJjaE9wdGlvbnMgPSB7fVxyXG4gICk6IFNlYXJjaFJlc3VsdDxHVE1WYXJpYWJsZT5bXSB7XHJcbiAgICBjb25zdCB7IHRvcEsgPSAxMCwgdGhyZXNob2xkID0gMCwgdmFyaWFibGVUeXBlIH0gPSBvcHRpb25zO1xyXG4gICAgY29uc3QgcXVlcnlUb2tlbnMgPSB0aGlzLnRva2VuaXplKHF1ZXJ5KTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy52YXJpYWJsZXNcclxuICAgICAgLmZpbHRlcih2ID0+ICF2YXJpYWJsZVR5cGUgfHwgdi50eXBlID09PSB2YXJpYWJsZVR5cGUpXHJcbiAgICAgIC5tYXAodmFyaWFibGUgPT4ge1xyXG4gICAgICAgIGNvbnN0IHsgc2NvcmUsIHJlYXNvbnMgfSA9IHRoaXMuY2FsY3VsYXRlTmFtZU1hdGNoU2NvcmUoXHJcbiAgICAgICAgICB2YXJpYWJsZS5uYW1lLFxyXG4gICAgICAgICAgcXVlcnksXHJcbiAgICAgICAgICBxdWVyeVRva2Vuc1xyXG4gICAgICAgICk7XHJcbiAgICAgICAgcmV0dXJuIHsgZW50aXR5OiB2YXJpYWJsZSwgc2NvcmUsIG1hdGNoUmVhc29uczogcmVhc29ucyB9O1xyXG4gICAgICB9KVxyXG4gICAgICAuZmlsdGVyKHIgPT4gci5zY29yZSA+IHRocmVzaG9sZClcclxuICAgICAgLnNvcnQoKGEsIGIpID0+IGIuc2NvcmUgLSBhLnNjb3JlKVxyXG4gICAgICAuc2xpY2UoMCwgdG9wSyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDsnbTrpoTsnLzroZwg7Yq466as6rGwIOqygOyDiVxyXG4gICAqL1xyXG4gIHNlYXJjaFRyaWdnZXJzQnlOYW1lKFxyXG4gICAgcXVlcnk6IHN0cmluZyxcclxuICAgIG9wdGlvbnM6IFNlYXJjaE9wdGlvbnMgPSB7fVxyXG4gICk6IFNlYXJjaFJlc3VsdDxHVE1UcmlnZ2VyPltdIHtcclxuICAgIGNvbnN0IHsgdG9wSyA9IDEwLCB0aHJlc2hvbGQgPSAwIH0gPSBvcHRpb25zO1xyXG4gICAgY29uc3QgcXVlcnlUb2tlbnMgPSB0aGlzLnRva2VuaXplKHF1ZXJ5KTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy50cmlnZ2Vyc1xyXG4gICAgICAubWFwKHRyaWdnZXIgPT4ge1xyXG4gICAgICAgIGNvbnN0IHsgc2NvcmUsIHJlYXNvbnMgfSA9IHRoaXMuY2FsY3VsYXRlTmFtZU1hdGNoU2NvcmUoXHJcbiAgICAgICAgICB0cmlnZ2VyLm5hbWUsXHJcbiAgICAgICAgICBxdWVyeSxcclxuICAgICAgICAgIHF1ZXJ5VG9rZW5zXHJcbiAgICAgICAgKTtcclxuICAgICAgICByZXR1cm4geyBlbnRpdHk6IHRyaWdnZXIsIHNjb3JlLCBtYXRjaFJlYXNvbnM6IHJlYXNvbnMgfTtcclxuICAgICAgfSlcclxuICAgICAgLmZpbHRlcihyID0+IHIuc2NvcmUgPiB0aHJlc2hvbGQpXHJcbiAgICAgIC5zb3J0KChhLCBiKSA9PiBiLnNjb3JlIC0gYS5zY29yZSlcclxuICAgICAgLnNsaWNlKDAsIHRvcEspO1xyXG4gIH1cclxuXHJcbiAgLy8gPT09PT09PT09PT09PT09PT09PT0gU2ltaWxhcml0eS1iYXNlZCBTZWFyY2ggPT09PT09PT09PT09PT09PT09PT1cclxuXHJcbiAgLyoqXHJcbiAgICog7Jyg7IKs7ZWcIO2DnOq3uCDssL7quLBcclxuICAgKi9cclxuICBmaW5kU2ltaWxhclRhZ3MoXHJcbiAgICByZWZlcmVuY2U6IEdUTVRhZyxcclxuICAgIG9wdGlvbnM6IFNpbWlsYXJpdHlPcHRpb25zID0ge31cclxuICApOiBTZWFyY2hSZXN1bHQ8R1RNVGFnPltdIHtcclxuICAgIGNvbnN0IHtcclxuICAgICAgY29uc2lkZXJOYW1lID0gdHJ1ZSxcclxuICAgICAgY29uc2lkZXJUeXBlID0gdHJ1ZSxcclxuICAgICAgY29uc2lkZXJQYXJhbWV0ZXJzID0gdHJ1ZSxcclxuICAgICAgdGhyZXNob2xkID0gMC41XHJcbiAgICB9ID0gb3B0aW9ucztcclxuXHJcbiAgICByZXR1cm4gdGhpcy50YWdzXHJcbiAgICAgIC5maWx0ZXIodGFnID0+IHRhZy50YWdJZCAhPT0gcmVmZXJlbmNlLnRhZ0lkKVxyXG4gICAgICAubWFwKHRhZyA9PiB7XHJcbiAgICAgICAgY29uc3QgeyBzY29yZSwgcmVhc29ucyB9ID0gdGhpcy5jYWxjdWxhdGVUYWdTaW1pbGFyaXR5KFxyXG4gICAgICAgICAgcmVmZXJlbmNlLFxyXG4gICAgICAgICAgdGFnLFxyXG4gICAgICAgICAgeyBjb25zaWRlck5hbWUsIGNvbnNpZGVyVHlwZSwgY29uc2lkZXJQYXJhbWV0ZXJzIH1cclxuICAgICAgICApO1xyXG4gICAgICAgIHJldHVybiB7IGVudGl0eTogdGFnLCBzY29yZSwgbWF0Y2hSZWFzb25zOiByZWFzb25zIH07XHJcbiAgICAgIH0pXHJcbiAgICAgIC5maWx0ZXIociA9PiByLnNjb3JlID49IHRocmVzaG9sZClcclxuICAgICAgLnNvcnQoKGEsIGIpID0+IGIuc2NvcmUgLSBhLnNjb3JlKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIO2KueyglSDtg4DsnoXsnZgg7YOc6re4IOywvuq4sCAoR0E0IOydtOuypO2KuCDrk7EpXHJcbiAgICovXHJcbiAgZmluZFRhZ3NCeVR5cGUodGFnVHlwZTogc3RyaW5nKTogR1RNVGFnW10ge1xyXG4gICAgcmV0dXJuIHRoaXMudGFncy5maWx0ZXIodGFnID0+IHRhZy50eXBlID09PSB0YWdUeXBlKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdBNCDsnbTrsqTtirgg7J2066aE7Jy866GcIO2DnOq3uCDssL7quLBcclxuICAgKi9cclxuICBmaW5kR0E0VGFnc0J5RXZlbnROYW1lKGV2ZW50TmFtZTogc3RyaW5nKTogR1RNVGFnW10ge1xyXG4gICAgcmV0dXJuIHRoaXMudGFncy5maWx0ZXIodGFnID0+IHtcclxuICAgICAgaWYgKHRhZy50eXBlICE9PSAnZ2Fhd2UnKSByZXR1cm4gZmFsc2U7XHJcblxyXG4gICAgICBjb25zdCBldmVudE5hbWVQYXJhbSA9IHRhZy5wYXJhbWV0ZXI/LmZpbmQocCA9PiBwLmtleSA9PT0gJ2V2ZW50TmFtZScpO1xyXG4gICAgICBpZiAoIWV2ZW50TmFtZVBhcmFtPy52YWx1ZSkgcmV0dXJuIGZhbHNlO1xyXG5cclxuICAgICAgcmV0dXJuIGV2ZW50TmFtZVBhcmFtLnZhbHVlLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoZXZlbnROYW1lLnRvTG93ZXJDYXNlKCkpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDsoJXtmZXtlZwg7J2066aE7Jy866GcIOywvuq4sFxyXG4gICAqL1xyXG4gIGZpbmRUYWdCeUV4YWN0TmFtZShuYW1lOiBzdHJpbmcpOiBHVE1UYWcgfCB1bmRlZmluZWQge1xyXG4gICAgcmV0dXJuIHRoaXMudGFncy5maW5kKHQgPT4gdC5uYW1lID09PSBuYW1lKTtcclxuICB9XHJcblxyXG4gIGZpbmRWYXJpYWJsZUJ5RXhhY3ROYW1lKG5hbWU6IHN0cmluZyk6IEdUTVZhcmlhYmxlIHwgdW5kZWZpbmVkIHtcclxuICAgIHJldHVybiB0aGlzLnZhcmlhYmxlcy5maW5kKHYgPT4gdi5uYW1lID09PSBuYW1lKTtcclxuICB9XHJcblxyXG4gIGZpbmRUcmlnZ2VyQnlFeGFjdE5hbWUobmFtZTogc3RyaW5nKTogR1RNVHJpZ2dlciB8IHVuZGVmaW5lZCB7XHJcbiAgICByZXR1cm4gdGhpcy50cmlnZ2Vycy5maW5kKHQgPT4gdC5uYW1lID09PSBuYW1lKTtcclxuICB9XHJcblxyXG4gIC8vID09PT09PT09PT09PT09PT09PT09IFByaXZhdGUgTWV0aG9kcyA9PT09PT09PT09PT09PT09PT09PVxyXG5cclxuICAvKipcclxuICAgKiDsnbTrpoQg66ek7LmtIOygkOyImCDqs4TsgrBcclxuICAgKi9cclxuICBwcml2YXRlIGNhbGN1bGF0ZU5hbWVNYXRjaFNjb3JlKFxyXG4gICAgbmFtZTogc3RyaW5nLFxyXG4gICAgcXVlcnk6IHN0cmluZyxcclxuICAgIHF1ZXJ5VG9rZW5zOiBzdHJpbmdbXSxcclxuICAgIGV4dHJhVGV4dD86IHN0cmluZ1xyXG4gICk6IHsgc2NvcmU6IG51bWJlcjsgcmVhc29uczogc3RyaW5nW10gfSB7XHJcbiAgICBsZXQgc2NvcmUgPSAwO1xyXG4gICAgY29uc3QgcmVhc29uczogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICBjb25zdCBuYW1lTG93ZXIgPSBuYW1lLnRvTG93ZXJDYXNlKCk7XHJcbiAgICBjb25zdCBxdWVyeUxvd2VyID0gcXVlcnkudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICAvLyAxLiDsoJXtmZXtlZwg7J2066aEIOunpOy5rSAoMTAw7KCQKVxyXG4gICAgaWYgKG5hbWVMb3dlciA9PT0gcXVlcnlMb3dlcikge1xyXG4gICAgICBzY29yZSArPSAxMDA7XHJcbiAgICAgIHJlYXNvbnMucHVzaCgnZXhhY3QgbWF0Y2gnKTtcclxuICAgIH1cclxuICAgIC8vIDIuIOydtOumhOyXkCDqsoDsg4nslrQg7Y+s7ZWoICg1MOygkClcclxuICAgIGVsc2UgaWYgKG5hbWVMb3dlci5pbmNsdWRlcyhxdWVyeUxvd2VyKSkge1xyXG4gICAgICBzY29yZSArPSA1MDtcclxuICAgICAgcmVhc29ucy5wdXNoKCdjb250YWlucyBxdWVyeScpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIDMuIO2GoO2BsCDrp6Tsua0gKOy1nOuMgCAzMOygkClcclxuICAgIGNvbnN0IG5hbWVUb2tlbnMgPSB0aGlzLnRva2VuaXplKG5hbWUpO1xyXG4gICAgbGV0IG1hdGNoZWRUb2tlbnMgPSAwO1xyXG5cclxuICAgIGZvciAoY29uc3QgcXVlcnlUb2tlbiBvZiBxdWVyeVRva2Vucykge1xyXG4gICAgICBmb3IgKGNvbnN0IG5hbWVUb2tlbiBvZiBuYW1lVG9rZW5zKSB7XHJcbiAgICAgICAgaWYgKG5hbWVUb2tlbi5pbmNsdWRlcyhxdWVyeVRva2VuKSB8fCBxdWVyeVRva2VuLmluY2x1ZGVzKG5hbWVUb2tlbikpIHtcclxuICAgICAgICAgIG1hdGNoZWRUb2tlbnMrKztcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChtYXRjaGVkVG9rZW5zID4gMCAmJiBxdWVyeVRva2Vucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGNvbnN0IHRva2VuU2NvcmUgPSAobWF0Y2hlZFRva2VucyAvIHF1ZXJ5VG9rZW5zLmxlbmd0aCkgKiAzMDtcclxuICAgICAgc2NvcmUgKz0gdG9rZW5TY29yZTtcclxuICAgICAgcmVhc29ucy5wdXNoKGAke21hdGNoZWRUb2tlbnN9LyR7cXVlcnlUb2tlbnMubGVuZ3RofSB0b2tlbnNgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyA0LiDstpTqsIAg7YWN7Iqk7Yq4IOunpOy5rSAoMTDsoJApXHJcbiAgICBpZiAoZXh0cmFUZXh0ICYmIGV4dHJhVGV4dC50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHF1ZXJ5TG93ZXIpKSB7XHJcbiAgICAgIHNjb3JlICs9IDEwO1xyXG4gICAgICByZWFzb25zLnB1c2goJ2V4dHJhIHRleHQgbWF0Y2gnKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4geyBzY29yZSwgcmVhc29ucyB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog7YOc6re4IOycoOyCrOuPhCDqs4TsgrBcclxuICAgKi9cclxuICBwcml2YXRlIGNhbGN1bGF0ZVRhZ1NpbWlsYXJpdHkoXHJcbiAgICByZWZlcmVuY2U6IEdUTVRhZyxcclxuICAgIHRhcmdldDogR1RNVGFnLFxyXG4gICAgb3B0aW9uczogeyBjb25zaWRlck5hbWU6IGJvb2xlYW47IGNvbnNpZGVyVHlwZTogYm9vbGVhbjsgY29uc2lkZXJQYXJhbWV0ZXJzOiBib29sZWFuIH1cclxuICApOiB7IHNjb3JlOiBudW1iZXI7IHJlYXNvbnM6IHN0cmluZ1tdIH0ge1xyXG4gICAgbGV0IHRvdGFsV2VpZ2h0ID0gMDtcclxuICAgIGxldCB0b3RhbFNjb3JlID0gMDtcclxuICAgIGNvbnN0IHJlYXNvbnM6IHN0cmluZ1tdID0gW107XHJcblxyXG4gICAgLy8gMS4g7YOA7J6FIOycoOyCrOuPhCAoNDAlKVxyXG4gICAgaWYgKG9wdGlvbnMuY29uc2lkZXJUeXBlKSB7XHJcbiAgICAgIHRvdGFsV2VpZ2h0ICs9IDQwO1xyXG4gICAgICBpZiAocmVmZXJlbmNlLnR5cGUgPT09IHRhcmdldC50eXBlKSB7XHJcbiAgICAgICAgdG90YWxTY29yZSArPSA0MDtcclxuICAgICAgICByZWFzb25zLnB1c2goJ3NhbWUgdHlwZScpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gMi4g7J2066aEIOycoOyCrOuPhCAoMzAlKVxyXG4gICAgaWYgKG9wdGlvbnMuY29uc2lkZXJOYW1lKSB7XHJcbiAgICAgIHRvdGFsV2VpZ2h0ICs9IDMwO1xyXG4gICAgICBjb25zdCBuYW1lU2ltaWxhcml0eSA9IHRoaXMuY2FsY3VsYXRlU3RyaW5nU2ltaWxhcml0eShyZWZlcmVuY2UubmFtZSwgdGFyZ2V0Lm5hbWUpO1xyXG4gICAgICB0b3RhbFNjb3JlICs9IG5hbWVTaW1pbGFyaXR5ICogMzA7XHJcbiAgICAgIGlmIChuYW1lU2ltaWxhcml0eSA+IDAuNSkge1xyXG4gICAgICAgIHJlYXNvbnMucHVzaChgbmFtZSBzaW1pbGFyaXR5OiAkeyhuYW1lU2ltaWxhcml0eSAqIDEwMCkudG9GaXhlZCgwKX0lYCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyAzLiDtjIzrnbzrr7jthLAg7Jyg7IKs64+EICgzMCUpXHJcbiAgICBpZiAob3B0aW9ucy5jb25zaWRlclBhcmFtZXRlcnMgJiYgcmVmZXJlbmNlLnBhcmFtZXRlciAmJiB0YXJnZXQucGFyYW1ldGVyKSB7XHJcbiAgICAgIHRvdGFsV2VpZ2h0ICs9IDMwO1xyXG4gICAgICBjb25zdCBwYXJhbVNpbWlsYXJpdHkgPSB0aGlzLmNhbGN1bGF0ZVBhcmFtZXRlclNpbWlsYXJpdHkoXHJcbiAgICAgICAgcmVmZXJlbmNlLnBhcmFtZXRlcixcclxuICAgICAgICB0YXJnZXQucGFyYW1ldGVyXHJcbiAgICAgICk7XHJcbiAgICAgIHRvdGFsU2NvcmUgKz0gcGFyYW1TaW1pbGFyaXR5ICogMzA7XHJcbiAgICAgIGlmIChwYXJhbVNpbWlsYXJpdHkgPiAwLjUpIHtcclxuICAgICAgICByZWFzb25zLnB1c2goYHBhcmFtIHNpbWlsYXJpdHk6ICR7KHBhcmFtU2ltaWxhcml0eSAqIDEwMCkudG9GaXhlZCgwKX0lYCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBmaW5hbFNjb3JlID0gdG90YWxXZWlnaHQgPiAwID8gdG90YWxTY29yZSAvIHRvdGFsV2VpZ2h0IDogMDtcclxuXHJcbiAgICByZXR1cm4geyBzY29yZTogZmluYWxTY29yZSwgcmVhc29ucyB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog66y47J6Q7Je0IOycoOyCrOuPhCAoSmFjY2FyZCBzaW1pbGFyaXR5KVxyXG4gICAqL1xyXG4gIHByaXZhdGUgY2FsY3VsYXRlU3RyaW5nU2ltaWxhcml0eShhOiBzdHJpbmcsIGI6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICBjb25zdCB0b2tlbnNBID0gbmV3IFNldCh0aGlzLnRva2VuaXplKGEpKTtcclxuICAgIGNvbnN0IHRva2Vuc0IgPSBuZXcgU2V0KHRoaXMudG9rZW5pemUoYikpO1xyXG5cclxuICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IG5ldyBTZXQoWy4uLnRva2Vuc0FdLmZpbHRlcih4ID0+IHRva2Vuc0IuaGFzKHgpKSk7XHJcbiAgICBjb25zdCB1bmlvbiA9IG5ldyBTZXQoWy4uLnRva2Vuc0EsIC4uLnRva2Vuc0JdKTtcclxuXHJcbiAgICBpZiAodW5pb24uc2l6ZSA9PT0gMCkgcmV0dXJuIDA7XHJcblxyXG4gICAgcmV0dXJuIGludGVyc2VjdGlvbi5zaXplIC8gdW5pb24uc2l6ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIO2MjOudvOuvuO2EsCDsnKDsgqzrj4RcclxuICAgKi9cclxuICBwcml2YXRlIGNhbGN1bGF0ZVBhcmFtZXRlclNpbWlsYXJpdHkoXHJcbiAgICBwYXJhbXNBOiBHVE1QYXJhbWV0ZXJbXSxcclxuICAgIHBhcmFtc0I6IEdUTVBhcmFtZXRlcltdXHJcbiAgKTogbnVtYmVyIHtcclxuICAgIGNvbnN0IGtleXNBID0gbmV3IFNldChwYXJhbXNBLm1hcChwID0+IHAua2V5KSk7XHJcbiAgICBjb25zdCBrZXlzQiA9IG5ldyBTZXQocGFyYW1zQi5tYXAocCA9PiBwLmtleSkpO1xyXG5cclxuICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IG5ldyBTZXQoWy4uLmtleXNBXS5maWx0ZXIoeCA9PiBrZXlzQi5oYXMoeCkpKTtcclxuICAgIGNvbnN0IHVuaW9uID0gbmV3IFNldChbLi4ua2V5c0EsIC4uLmtleXNCXSk7XHJcblxyXG4gICAgaWYgKHVuaW9uLnNpemUgPT09IDApIHJldHVybiAwO1xyXG5cclxuICAgIHJldHVybiBpbnRlcnNlY3Rpb24uc2l6ZSAvIHVuaW9uLnNpemU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDthY3siqTtirgg7Yag7YGw7ZmUXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB0b2tlbml6ZSh0ZXh0OiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICByZXR1cm4gdGV4dFxyXG4gICAgICAudG9Mb3dlckNhc2UoKVxyXG4gICAgICAuc3BsaXQoL1tcXHNcXC1fXFwuXSsvKVxyXG4gICAgICAuZmlsdGVyKHRva2VuID0+IHRva2VuLmxlbmd0aCA+IDEpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog7YOc6re47JeQ7IScIOy2lOqwgCDqsoDsg4kg7YWN7Iqk7Yq4IOy2lOy2nFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VGFnRXh0cmFUZXh0KHRhZzogR1RNVGFnKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IHBhcnRzOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgIC8vIOydtOuypO2KuCDsnbTrpoRcclxuICAgIGNvbnN0IGV2ZW50TmFtZVBhcmFtID0gdGFnLnBhcmFtZXRlcj8uZmluZChwID0+IHAua2V5ID09PSAnZXZlbnROYW1lJyk7XHJcbiAgICBpZiAoZXZlbnROYW1lUGFyYW0/LnZhbHVlKSB7XHJcbiAgICAgIHBhcnRzLnB1c2goZXZlbnROYW1lUGFyYW0udmFsdWUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIE5vdGVzXHJcbiAgICBpZiAodGFnLm5vdGVzKSB7XHJcbiAgICAgIHBhcnRzLnB1c2godGFnLm5vdGVzKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcGFydHMuam9pbignICcpO1xyXG4gIH1cclxufVxyXG5cclxuLy8gPT09PT09PT09PT09PT09PT09PT0gVXRpbGl0eSBGdW5jdGlvbnMgPT09PT09PT09PT09PT09PT09PT1cclxuXHJcbi8qKlxyXG4gKiDtg5zqt7jrpbwg6rKA7IOJIOqwgOuKpe2VnCDthY3siqTtirjroZwg67OA7ZmYXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gdGFnVG9TZWFyY2hhYmxlVGV4dCh0YWc6IEdUTVRhZyk6IHN0cmluZyB7XHJcbiAgY29uc3QgcGFydHM6IHN0cmluZ1tdID0gW3RhZy5uYW1lLCB0YWcudHlwZV07XHJcblxyXG4gIGNvbnN0IGV2ZW50TmFtZVBhcmFtID0gdGFnLnBhcmFtZXRlcj8uZmluZChwID0+IHAua2V5ID09PSAnZXZlbnROYW1lJyk7XHJcbiAgaWYgKGV2ZW50TmFtZVBhcmFtPy52YWx1ZSkge1xyXG4gICAgcGFydHMucHVzaChldmVudE5hbWVQYXJhbS52YWx1ZSk7XHJcbiAgfVxyXG5cclxuICBpZiAodGFnLm5vdGVzKSB7XHJcbiAgICBwYXJ0cy5wdXNoKHRhZy5ub3Rlcyk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcGFydHMuam9pbignICcpO1xyXG59XHJcblxyXG4vKipcclxuICog7Jyg7IKs64+EIOq4sOuwmCDtg5zqt7gg6re466O57ZWRXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ3JvdXBTaW1pbGFyVGFncyhcclxuICB0YWdzOiBHVE1UYWdbXSxcclxuICB0aHJlc2hvbGQ6IG51bWJlciA9IDAuN1xyXG4pOiBNYXA8c3RyaW5nLCBHVE1UYWdbXT4ge1xyXG4gIGNvbnN0IGdyb3VwcyA9IG5ldyBNYXA8c3RyaW5nLCBHVE1UYWdbXT4oKTtcclxuICBjb25zdCBhc3NpZ25lZCA9IG5ldyBTZXQ8c3RyaW5nPigpO1xyXG5cclxuICBmb3IgKGNvbnN0IHRhZyBvZiB0YWdzKSB7XHJcbiAgICBpZiAoYXNzaWduZWQuaGFzKHRhZy50YWdJZCkpIGNvbnRpbnVlO1xyXG5cclxuICAgIGNvbnN0IGdyb3VwS2V5ID0gdGFnLnRhZ0lkO1xyXG4gICAgY29uc3QgZ3JvdXA6IEdUTVRhZ1tdID0gW3RhZ107XHJcbiAgICBhc3NpZ25lZC5hZGQodGFnLnRhZ0lkKTtcclxuXHJcbiAgICBjb25zdCBtYXRjaGVyID0gbmV3IFJlZmVyZW5jZU1hdGNoZXIoW3RhZ10sIFtdLCBbXSk7XHJcbiAgICBtYXRjaGVyLnNldEVudGl0aWVzKHRhZ3MsIFtdLCBbXSk7XHJcblxyXG4gICAgY29uc3Qgc2ltaWxhciA9IG1hdGNoZXIuZmluZFNpbWlsYXJUYWdzKHRhZywgeyB0aHJlc2hvbGQgfSk7XHJcblxyXG4gICAgZm9yIChjb25zdCByZXN1bHQgb2Ygc2ltaWxhcikge1xyXG4gICAgICBpZiAoIWFzc2lnbmVkLmhhcyhyZXN1bHQuZW50aXR5LnRhZ0lkKSkge1xyXG4gICAgICAgIGdyb3VwLnB1c2gocmVzdWx0LmVudGl0eSk7XHJcbiAgICAgICAgYXNzaWduZWQuYWRkKHJlc3VsdC5lbnRpdHkudGFnSWQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ3JvdXBzLnNldChncm91cEtleSwgZ3JvdXApO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGdyb3VwcztcclxufVxyXG4iXX0=